import{u as Pe,a as Be,r as n,b as m,j as a,N as Oe}from"./index-BTwzOfe7.js";import{C as g,b as y}from"./Card-D96WZEWZ.js";import{u as Te,T as Ie}from"./Toast-DEpBsUw6.js";import{C as te}from"./ConfirmModal-C9Rl68DI.js";const se=3e3;let I=0;function qe(){const{user:f}=Pe(),U=Be(),{toasts:ne,showToast:l,removeToast:le}=Te(),_=n.useRef(!1),[b,de]=n.useState([]),[h,F]=n.useState([]),[ie,oe]=n.useState([]),[ce,L]=n.useState(!1),[ue,N]=n.useState(!1),[me,w]=n.useState(!1),[u,C]=n.useState(null),[E,$]=n.useState(!1),[q,z]=n.useState(!1),[pe,D]=n.useState({}),[G,H]=n.useState(!1),[S,W]=n.useState(!1),[k,xe]=n.useState(""),[j,be]=n.useState(""),[v,he]=n.useState(""),[M,J]=n.useState(""),[K,ge]=n.useState("bid"),[A,Q]=n.useState(""),[R,V]=n.useState(""),[i,ye]=n.useState("round_ou"),[X,fe]=n.useState(1),[P,ke]=n.useState(""),[B,Y]=n.useState(""),[p,je]=n.useState(""),[x,O]=n.useState([{user_id:0,guess:""},{user_id:0,guess:""}]),[Z,ee]=n.useState(!1);if(n.useEffect(()=>{if(!f?.admin||_.current)return;const e=Date.now();if(e-I<se)return;_.current=!0,I=e;let r=!1;return L(!0),Promise.all([m.adminGetUsers(),m.getMarkets(),m.getParticipants()]).then(([t,d,o])=>{r||(de(t.users??[]),F(d.markets??[]),oe((o.participants??[]).map(s=>({id:s.id??s.name,name:s.name}))))}).catch(()=>{r||(_.current=!1,l("Failed to load admin data","error"))}).finally(()=>{r||L(!1)}),()=>{r=!0,setTimeout(()=>{I=0},se+500)}},[f?.admin]),f&&!f.admin)return a.jsx(Oe,{to:"/markets",replace:!0});const ve=h.find(e=>e.market_id===v)?.outcomes??[];async function _e(){$(!0);try{const{canceled:e}=await m.adminCancelAllOrders();l(`${e} order(s) canceled`,"success")}catch(e){l(e instanceof Error?e.message:"Failed to cancel orders","error")}finally{$(!1),N(!1)}}async function Ne(){if(u!=null){z(!0);try{const{canceled:e}=await m.adminCancelAllOrders(u),r=b.find(t=>t.id===u);l(`${e} order(s) canceled for ${r?.username??u}`,"success")}catch(e){l(e instanceof Error?e.message:"Failed to cancel orders","error")}finally{z(!1),w(!1),C(null)}}}async function we(e,r){D(t=>({...t,[e]:!0}));try{await m.adminUpdateMarketPause(e,r),F(t=>t.map(d=>d.market_id===e?{...d,trading_paused:r?1:0}:d)),l(r?"Market paused":"Market resumed","success")}catch(t){l(t instanceof Error?t.message:"Failed to update market","error")}finally{D(t=>({...t,[e]:!1}))}}async function Ce(e){e.preventDefault();const r=k===""?null:Number(k),t=j===""?null:Number(j),d=A.trim()?parseInt(A,10):NaN,o=R.trim()?parseInt(R,10):NaN;if(r==null||!v||!M||Number.isNaN(d)||d<100||d>9900||Number.isNaN(o)||o<1){l("Fill required fields: taker, market, outcome, price (100–9900), contracts (≥1)","error");return}H(!0);try{await m.adminCreateManualTrade({taker_user_id:r,maker_user_id:t??void 0,market_id:v,outcome_id:M,side:K,price:d,contract_size:o}),l("Manual trade created","success"),Q(""),V("")}catch(s){l(s instanceof Error?s.message:"Failed to create manual trade","error")}finally{H(!1)}}function Se(){O(e=>[...e,{user_id:0,guess:""}])}function Me(e){O(r=>r.filter((t,d)=>d!==e))}function ae(e,r,t){O(d=>d.map((o,s)=>s===e?{...o,[r]:t}:o))}async function Ae(e){if(e.preventDefault(),x.length<2){l("At least 2 bids are required","error");return}const r=x.map(s=>s.user_id);if(r.some((s,c)=>s!==0&&r.indexOf(s)!==c)){l("Duplicate user in bids; each user may only appear once","error");return}const d=[];for(let s=0;s<x.length;s++){const c=x[s].user_id,T=x[s].guess.trim()?parseFloat(x[s].guess):NaN;if(!c||Number.isNaN(T)){l(`Bid ${s+1}: select user and enter a numeric guess`,"error");return}d.push({user_id:c,guess:T})}if(i==="round_ou"&&!P){l("Select a participant","error");return}let o="";if(i==="pars")if(p&&p!=="__new__"){const s=h.filter(c=>c.market_type==="pars"||c.short_name&&c.short_name.toLowerCase().includes("pars"));for(const c of s)if((c.outcomes??[]).find(Re=>Re.outcome_id===p)){o=c.market_id;break}if(!o){l("Selected line not found","error");return}}else if(p==="__new__"&&B)o=B;else{l("Select a line or choose New line and a market","error");return}ee(!0);try{const s=await m.adminRunRoundOuAuction({auction_type:i,...i==="round_ou"&&{round:X},...i==="round_ou"&&{participant_id:P},...i==="pars"&&o&&{market_id:o},...i==="pars"&&p&&p!=="__new__"&&{outcome_id:p},bids:d});l(`Auction done. Strike: ${s.strike}. ${s.trades_created} trade(s) created.`,"success"),U(`/markets/${s.market_id}`)}catch(s){l(s instanceof Error?s.message:"Failed to run auction","error")}finally{ee(!1)}}async function re(e){W(!0);try{let r=await m.adminReplayPositions(e?{full_reset:!0}:void 0),t=r.trades_replayed;for(;r.has_more&&r.after_trade_id!=null;)r=await m.adminReplayPositions({after_trade_id:r.after_trade_id}),t+=r.trades_replayed;l(r.message??`Done. ${t} trades replayed.`,"success"),r.trades_skipped!=null&&r.trades_skipped>0&&l(`${r.trades_skipped} trade(s) skipped (missing taker_user_id or taker_side)`,"info")}catch(r){l(r instanceof Error?r.message:"Failed to replay positions","error")}finally{W(!1)}}return a.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[a.jsx("div",{className:"flex items-center gap-2 sm:gap-4",children:a.jsxs("button",{onClick:()=>U("/markets"),className:"flex items-center gap-2 px-3 sm:px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary-600 dark:hover:text-primary-400 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-800 transition touch-manipulation",children:[a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),a.jsx("span",{className:"hidden sm:inline",children:"Back"})]})}),a.jsx("h1",{className:"text-xl sm:text-2xl font-bold",children:"Admin"}),a.jsx(g,{children:a.jsxs(y,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Cancel orders"}),a.jsxs("div",{className:"flex flex-wrap gap-3 items-center",children:[a.jsx("button",{type:"button",onClick:()=>N(!0),disabled:E,className:"px-3 py-2 text-sm font-medium bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50",children:E?"Canceling…":"Cancel all open orders (all users)"}),a.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:"or for user:"}),a.jsxs("select",{value:u??"",onChange:e=>C(e.target.value?Number(e.target.value):null),className:"border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select user"}),b.map(e=>a.jsxs("option",{value:e.id,children:[e.username," (id: ",e.id,")"]},e.id))]}),a.jsx("button",{type:"button",onClick:()=>u!=null&&w(!0),disabled:u==null||q,className:"px-3 py-2 text-sm font-medium bg-amber-600 text-white rounded-md hover:bg-amber-700 disabled:opacity-50",children:q?"Canceling…":"Cancel all for this user"})]})]})}),a.jsx(g,{children:a.jsxs(y,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Ensure portfolio values are zero-sum"}),a.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400 mb-3",children:["Portfolio value (unrealized P&L) should sum to zero. ",a.jsx("strong",{children:"Replay positions"})," recomputes ",a.jsx("code",{className:"text-xs",children:"net_position"})," and ",a.jsx("code",{className:"text-xs",children:"price_basis"})," from trade history. ",a.jsx("strong",{children:"Replay with full reset"})," zeros all positions first, then replays (clean slate)."]}),a.jsxs("div",{className:"flex flex-wrap gap-2",children:[a.jsx("button",{type:"button",onClick:()=>re(!1),disabled:S,className:"px-3 py-1.5 text-sm font-medium rounded-md bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50",children:S?"Running…":"Replay positions"}),a.jsx("button",{type:"button",onClick:()=>re(!0),disabled:S,className:"px-3 py-1.5 text-sm font-medium rounded-md bg-blue-500 text-white hover:bg-blue-600 disabled:opacity-50",children:"Replay with full reset"})]})]})}),a.jsx(g,{children:a.jsxs(y,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Pause / resume trading by market"}),ce?a.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading markets…"}):a.jsx("ul",{className:"space-y-2",children:h.map(e=>{const r=(e.trading_paused??0)===1,t=pe[e.market_id];return a.jsxs("li",{className:"flex items-center justify-between gap-2 py-2 border-b border-gray-200 dark:border-gray-700 last:border-0",children:[a.jsx("span",{className:"text-sm font-medium truncate",children:e.short_name}),a.jsx("button",{type:"button",onClick:()=>we(e.market_id,!r),disabled:t,className:`px-3 py-1.5 text-sm font-medium rounded-md disabled:opacity-50 ${r?"bg-green-600 text-white hover:bg-green-700":"bg-gray-500 text-white hover:bg-gray-600"}`,children:t?"…":r?"Resume":"Pause"})]},e.market_id)})})]})}),a.jsx(g,{children:a.jsxs(y,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Add manual trade"}),a.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mb-3",children:"Record a trade like normal matching: taker is the one who took (placed the crossing order); maker is whose order was hit. Side is the taker's side (bid = buy, ask = sell). Both positions are updated when maker is set."}),a.jsxs("form",{onSubmit:Ce,className:"space-y-3",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Taker (required)"}),a.jsxs("select",{value:k===""?"":k,onChange:e=>xe(e.target.value?Number(e.target.value):""),required:!0,className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select taker"}),b.map(e=>a.jsxs("option",{value:e.id,children:[e.username," (id: ",e.id,")"]},e.id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Maker (optional)"}),a.jsxs("select",{value:j===""?"":String(j),onChange:e=>be(e.target.value?Number(e.target.value):""),className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"None (house / system)"}),b.map(e=>a.jsxs("option",{value:e.id,children:[e.username," (id: ",e.id,")"]},e.id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Market"}),a.jsxs("select",{value:v,onChange:e=>{he(e.target.value),J("")},required:!0,className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select market"}),h.map(e=>a.jsx("option",{value:e.market_id,children:e.short_name},e.market_id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Outcome"}),a.jsxs("select",{value:M,onChange:e=>J(e.target.value),required:!0,className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select outcome"}),ve.map(e=>a.jsx("option",{value:e.outcome_id,children:e.name},e.outcome_id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Taker side"}),a.jsxs("select",{value:K,onChange:e=>ge(e.target.value),className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"bid",children:"Bid (taker bought)"}),a.jsx("option",{value:"ask",children:"Ask (taker sold)"})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Price (cents, 100–9900)"}),a.jsx("input",{type:"number",min:100,max:9900,value:A,onChange:e=>Q(e.target.value),placeholder:"e.g. 5000",className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Contract size"}),a.jsx("input",{type:"number",min:1,value:R,onChange:e=>V(e.target.value),placeholder:"e.g. 10",className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm"})]}),a.jsx("button",{type:"submit",disabled:G,className:"px-3 py-2 text-sm font-medium bg-primary-600 text-white rounded-md hover:bg-primary-700 disabled:opacity-50",children:G?"Creating…":"Add manual trade"})]})]})}),a.jsx(g,{children:a.jsxs(y,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Auction"}),a.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mb-3",children:i==="round_ou"?"Round O/U: round (1–6), participant (golfer), and N bids (user + guess). Strike = average of guesses. Lowest half short, rest long; paired at 50¢.":"Pars: select a line (e.g. O8.5), then enter each person’s bid price (%). Trade price = average of bids. Lowest half short, rest long."}),a.jsxs("form",{onSubmit:Ae,className:"space-y-3",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Market type"}),a.jsxs("select",{value:i,onChange:e=>ye(e.target.value),className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"round_ou",children:"Round O/U"}),a.jsx("option",{value:"pars",children:"Pars (e.g. Boose Pars)"})]})]}),i==="round_ou"&&a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Round"}),a.jsx("select",{value:X,onChange:e=>fe(Number(e.target.value)),className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[1,2,3,4,5,6].map(e=>a.jsxs("option",{value:e,children:["Round ",e]},e))})]}),i==="round_ou"&&a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Participant"}),a.jsxs("select",{value:P,onChange:e=>ke(e.target.value),required:!0,className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select participant"}),ie.map(e=>a.jsx("option",{value:e.id,children:e.name},e.id))]})]}),i==="pars"&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Line"}),a.jsxs("select",{value:p||"",onChange:e=>{const r=e.target.value;je(r),r||Y("")},className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select line"}),h.filter(e=>e.market_type==="pars"||e.short_name&&e.short_name.toLowerCase().includes("pars")).flatMap(e=>(e.outcomes??[]).map(r=>({outcome_id:r.outcome_id,market_id:e.market_id,label:r.strike!=null&&r.strike!==""?`O${r.strike}`:r.name??r.outcome_id}))).map(e=>a.jsx("option",{value:e.outcome_id,children:e.label},e.outcome_id)),a.jsx("option",{value:"__new__",children:"— New line (strike from bid average) —"})]})]}),i==="pars"&&p==="__new__"&&a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Market (for new line)"}),a.jsxs("select",{value:B,onChange:e=>Y(e.target.value),className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select market"}),h.filter(e=>e.market_type==="pars"||e.short_name&&e.short_name.toLowerCase().includes("pars")).map(e=>a.jsx("option",{value:e.market_id,children:e.short_name},e.market_id))]})]})]}),a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center justify-between mb-1",children:[a.jsx("label",{className:"block text-sm font-medium",children:"Bids (min 2)"}),a.jsx("button",{type:"button",onClick:Se,className:"text-sm text-primary-600 dark:text-primary-400 hover:underline",children:"Add bid"})]}),a.jsx("div",{className:"space-y-2",children:x.map((e,r)=>a.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[a.jsxs("select",{value:e.user_id||"",onChange:t=>ae(r,"user_id",Number(t.target.value)||0),className:"flex-1 min-w-[120px] border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"User"}),b.map(t=>a.jsx("option",{value:t.id,children:t.username},t.id))]}),a.jsx("input",{type:"number",step:"any",min:i==="pars"?0:void 0,max:i==="pars"?100:void 0,value:e.guess,onChange:t=>ae(r,"guess",t.target.value),placeholder:i==="pars"?"Bid %":"Guess",className:"w-20 border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm"}),x.length>2&&a.jsx("button",{type:"button",onClick:()=>Me(r),className:"p-1.5 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded","aria-label":"Remove bid",children:"×"})]},r))})]}),a.jsx("button",{type:"submit",disabled:Z,className:"px-3 py-2 text-sm font-medium bg-primary-600 text-white rounded-md hover:bg-primary-700 disabled:opacity-50",children:Z?"Running…":"Run auction"})]})]})}),a.jsx(te,{isOpen:ue,onClose:()=>N(!1),onConfirm:_e,title:"Cancel all open orders",message:"Cancel all open/partial orders for every user? This cannot be undone.",confirmLabel:"Cancel all",variant:"danger"}),a.jsx(te,{isOpen:me,onClose:()=>{w(!1),C(null)},onConfirm:Ne,title:"Cancel all orders for this user",message:u!=null?`Cancel all open/partial orders for user ${b.find(e=>e.id===u)?.username??u}?`:"",confirmLabel:"Cancel all",variant:"danger"}),a.jsx(Ie,{toasts:ne,removeToast:le})]})}export{qe as AdminPage};
