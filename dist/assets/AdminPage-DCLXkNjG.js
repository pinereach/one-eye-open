import{u as Te,a as Ie,r as n,b as u,j as a,N as Ue}from"./index-C0r5nw18.js";import{C as g,b as y}from"./Card-C0z3U-Gr.js";import{u as Fe,T as Le}from"./Toast-BvH_Xu0w.js";import{C as ne}from"./ConfirmModal-CUuXAGgp.js";const le=3e3;let I=0;function ze(){const{user:f}=Te(),U=Ie(),{toasts:de,showToast:l,removeToast:oe}=Fe(),_=n.useRef(!1),[x,ie]=n.useState([]),[b,F]=n.useState([]),[ce,ue]=n.useState([]),[me,L]=n.useState(!1),[pe,N]=n.useState(!1),[he,w]=n.useState(!1),[m,C]=n.useState(null),[E,$]=n.useState(!1),[q,D]=n.useState(!1),[xe,V]=n.useState({}),[z,G]=n.useState(!1),[S,H]=n.useState(!1),[W,J]=n.useState(!1),[k,be]=n.useState(""),[j,ge]=n.useState(""),[v,ye]=n.useState(""),[A,K]=n.useState(""),[Q,fe]=n.useState("bid"),[M,X]=n.useState(""),[R,Y]=n.useState(""),[o,ke]=n.useState("round_ou"),[Z,je]=n.useState(1),[B,ve]=n.useState(""),[P,ee]=n.useState(""),[p,_e]=n.useState(""),[h,O]=n.useState([{user_id:0,guess:""},{user_id:0,guess:""}]),[ae,re]=n.useState(!1);if(n.useEffect(()=>{if(!f?.admin||_.current)return;const e=Date.now();if(e-I<le)return;_.current=!0,I=e;let r=!1;return L(!0),Promise.all([u.adminGetUsers(),u.getMarkets(),u.getParticipants()]).then(([t,d,i])=>{r||(ie(t.users??[]),F(d.markets??[]),ue((i.participants??[]).map(s=>({id:s.id??s.name,name:s.name}))))}).catch(()=>{r||(_.current=!1,l("Failed to load admin data","error"))}).finally(()=>{r||L(!1)}),()=>{r=!0,setTimeout(()=>{I=0},le+500)}},[f?.admin]),f&&!f.admin)return a.jsx(Ue,{to:"/markets",replace:!0});const Ne=b.find(e=>e.market_id===v)?.outcomes??[];async function we(){$(!0);try{const{canceled:e}=await u.adminCancelAllOrders();l(`${e} order(s) canceled`,"success")}catch(e){l(e instanceof Error?e.message:"Failed to cancel orders","error")}finally{$(!1),N(!1)}}async function Ce(){if(m!=null){D(!0);try{const{canceled:e}=await u.adminCancelAllOrders(m),r=x.find(t=>t.id===m);l(`${e} order(s) canceled for ${r?.username??m}`,"success")}catch(e){l(e instanceof Error?e.message:"Failed to cancel orders","error")}finally{D(!1),w(!1),C(null)}}}async function Se(e,r){V(t=>({...t,[e]:!0}));try{await u.adminUpdateMarketPause(e,r),F(t=>t.map(d=>d.market_id===e?{...d,trading_paused:r?1:0}:d)),l(r?"Market paused":"Market resumed","success")}catch(t){l(t instanceof Error?t.message:"Failed to update market","error")}finally{V(t=>({...t,[e]:!1}))}}async function Ae(e){e.preventDefault();const r=k===""?null:Number(k),t=j===""?null:Number(j),d=M.trim()?parseInt(M,10):NaN,i=R.trim()?parseInt(R,10):NaN;if(r==null||!v||!A||Number.isNaN(d)||d<100||d>9900||Number.isNaN(i)||i<1){l("Fill required fields: taker, market, outcome, price (100–9900), contracts (≥1)","error");return}G(!0);try{await u.adminCreateManualTrade({taker_user_id:r,maker_user_id:t??void 0,market_id:v,outcome_id:A,side:Q,price:d,contract_size:i}),l("Manual trade created","success"),X(""),Y("")}catch(s){l(s instanceof Error?s.message:"Failed to create manual trade","error")}finally{G(!1)}}function Me(){O(e=>[...e,{user_id:0,guess:""}])}function Re(e){O(r=>r.filter((t,d)=>d!==e))}function te(e,r,t){O(d=>d.map((i,s)=>s===e?{...i,[r]:t}:i))}async function Be(e){if(e.preventDefault(),h.length<2){l("At least 2 bids are required","error");return}const r=h.map(s=>s.user_id);if(r.some((s,c)=>s!==0&&r.indexOf(s)!==c)){l("Duplicate user in bids; each user may only appear once","error");return}const d=[];for(let s=0;s<h.length;s++){const c=h[s].user_id,T=h[s].guess.trim()?parseFloat(h[s].guess):NaN;if(!c||Number.isNaN(T)){l(`Bid ${s+1}: select user and enter a numeric guess`,"error");return}d.push({user_id:c,guess:T})}if(o==="round_ou"&&!B){l("Select a participant","error");return}let i="";if(o==="pars")if(p&&p!=="__new__"){const s=b.filter(c=>c.market_type==="pars"||c.short_name&&c.short_name.toLowerCase().includes("pars"));for(const c of s)if((c.outcomes??[]).find(Oe=>Oe.outcome_id===p)){i=c.market_id;break}if(!i){l("Selected line not found","error");return}}else if(p==="__new__"&&P)i=P;else{l("Select a line or choose New line and a market","error");return}re(!0);try{const s=await u.adminRunRoundOuAuction({auction_type:o,...o==="round_ou"&&{round:Z},...o==="round_ou"&&{participant_id:B},...o==="pars"&&i&&{market_id:i},...o==="pars"&&p&&p!=="__new__"&&{outcome_id:p},bids:d});l(`Auction done. Strike: ${s.strike}. ${s.trades_created} trade(s) created.`,"success"),U(`/markets/${s.market_id}`)}catch(s){l(s instanceof Error?s.message:"Failed to run auction","error")}finally{re(!1)}}async function se(e){H(!0);try{let r=await u.adminReplayPositions(e?{full_reset:!0}:void 0),t=r.trades_replayed;for(;r.has_more&&r.after_trade_id!=null;)r=await u.adminReplayPositions({after_trade_id:r.after_trade_id}),t+=r.trades_replayed;l(r.message??`Done. ${t} trades replayed.`,"success"),r.trades_skipped!=null&&r.trades_skipped>0&&l(`${r.trades_skipped} trade(s) skipped (missing taker_user_id or taker_side)`,"info")}catch(r){l(r instanceof Error?r.message:"Failed to replay positions","error")}finally{H(!1)}}async function Pe(){J(!0);try{const e=await u.adminRefreshVolume();l(`Volume cache updated for ${e?.updated??0} market(s)`,"success")}catch(e){l(e instanceof Error?e.message:"Failed to refresh volume","error")}finally{J(!1)}}return a.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[a.jsx("div",{className:"flex items-center gap-2 sm:gap-4",children:a.jsxs("button",{onClick:()=>U("/markets"),className:"flex items-center gap-2 px-3 sm:px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary-600 dark:hover:text-primary-400 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-800 transition touch-manipulation",children:[a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),a.jsx("span",{className:"hidden sm:inline",children:"Back"})]})}),a.jsx("h1",{className:"text-xl sm:text-2xl font-bold",children:"Admin"}),a.jsx(g,{children:a.jsxs(y,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Cancel orders"}),a.jsxs("div",{className:"flex flex-wrap gap-3 items-center",children:[a.jsx("button",{type:"button",onClick:()=>N(!0),disabled:E,className:"px-3 py-2 text-sm font-medium bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50",children:E?"Canceling…":"Cancel all open orders (all users)"}),a.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:"or for user:"}),a.jsxs("select",{value:m??"",onChange:e=>C(e.target.value?Number(e.target.value):null),className:"border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select user"}),x.map(e=>a.jsxs("option",{value:e.id,children:[e.username," (id: ",e.id,")"]},e.id))]}),a.jsx("button",{type:"button",onClick:()=>m!=null&&w(!0),disabled:m==null||q,className:"px-3 py-2 text-sm font-medium bg-amber-600 text-white rounded-md hover:bg-amber-700 disabled:opacity-50",children:q?"Canceling…":"Cancel all for this user"})]})]})}),a.jsx(g,{children:a.jsxs(y,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Volume cache"}),a.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mb-3",children:"Recompute 30-day volume per market so list and detail pages show correct volume. Also runs automatically every 4 hours via cron."}),a.jsx("button",{type:"button",onClick:Pe,disabled:W,className:"px-3 py-2 text-sm font-medium rounded-md bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-50",children:W?"Refreshing…":"Refresh volume"})]})}),a.jsx(g,{children:a.jsxs(y,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Ensure portfolio values are zero-sum"}),a.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400 mb-3",children:["Portfolio value (unrealized P&L) should sum to zero. ",a.jsx("strong",{children:"Replay positions"})," recomputes ",a.jsx("code",{className:"text-xs",children:"net_position"})," and ",a.jsx("code",{className:"text-xs",children:"price_basis"})," from trade history. ",a.jsx("strong",{children:"Replay with full reset"})," deletes all position rows, then replays so positions are re-created only from the trade log (clean slate)."]}),a.jsxs("div",{className:"flex flex-wrap gap-2",children:[a.jsx("button",{type:"button",onClick:()=>se(!1),disabled:S,className:"px-3 py-1.5 text-sm font-medium rounded-md bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50",children:S?"Running…":"Replay positions"}),a.jsx("button",{type:"button",onClick:()=>se(!0),disabled:S,className:"px-3 py-1.5 text-sm font-medium rounded-md bg-blue-500 text-white hover:bg-blue-600 disabled:opacity-50",children:"Replay with full reset"})]})]})}),a.jsx(g,{children:a.jsxs(y,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Pause / resume trading by market"}),me?a.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading markets…"}):a.jsx("ul",{className:"space-y-2",children:b.map(e=>{const r=(e.trading_paused??0)===1,t=xe[e.market_id];return a.jsxs("li",{className:"flex items-center justify-between gap-2 py-2 border-b border-gray-200 dark:border-gray-700 last:border-0",children:[a.jsx("span",{className:"text-sm font-medium truncate",children:e.short_name}),a.jsx("button",{type:"button",onClick:()=>Se(e.market_id,!r),disabled:t,className:`px-3 py-1.5 text-sm font-medium rounded-md disabled:opacity-50 ${r?"bg-green-600 text-white hover:bg-green-700":"bg-gray-500 text-white hover:bg-gray-600"}`,children:t?"…":r?"Resume":"Pause"})]},e.market_id)})})]})}),a.jsx(g,{children:a.jsxs(y,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Add manual trade"}),a.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mb-3",children:"Record a trade like normal matching: taker is the one who took (placed the crossing order); maker is whose order was hit. Side is the taker's side (bid = buy, ask = sell). Both positions are updated when maker is set."}),a.jsxs("form",{onSubmit:Ae,className:"space-y-3",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Taker (required)"}),a.jsxs("select",{value:k===""?"":k,onChange:e=>be(e.target.value?Number(e.target.value):""),required:!0,className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select taker"}),x.map(e=>a.jsxs("option",{value:e.id,children:[e.username," (id: ",e.id,")"]},e.id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Maker (optional)"}),a.jsxs("select",{value:j===""?"":String(j),onChange:e=>ge(e.target.value?Number(e.target.value):""),className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"None (house / system)"}),x.map(e=>a.jsxs("option",{value:e.id,children:[e.username," (id: ",e.id,")"]},e.id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Market"}),a.jsxs("select",{value:v,onChange:e=>{ye(e.target.value),K("")},required:!0,className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select market"}),b.map(e=>a.jsx("option",{value:e.market_id,children:e.short_name},e.market_id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Outcome"}),a.jsxs("select",{value:A,onChange:e=>K(e.target.value),required:!0,className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select outcome"}),Ne.map(e=>a.jsx("option",{value:e.outcome_id,children:e.name},e.outcome_id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Taker side"}),a.jsxs("select",{value:Q,onChange:e=>fe(e.target.value),className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"bid",children:"Bid (taker bought)"}),a.jsx("option",{value:"ask",children:"Ask (taker sold)"})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Price (cents, 100–9900)"}),a.jsx("input",{type:"number",min:100,max:9900,value:M,onChange:e=>X(e.target.value),placeholder:"e.g. 5000",className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Contract size"}),a.jsx("input",{type:"number",min:1,value:R,onChange:e=>Y(e.target.value),placeholder:"e.g. 10",className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm"})]}),a.jsx("button",{type:"submit",disabled:z,className:"px-3 py-2 text-sm font-medium bg-primary-600 text-white rounded-md hover:bg-primary-700 disabled:opacity-50",children:z?"Creating…":"Add manual trade"})]})]})}),a.jsx(g,{children:a.jsxs(y,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Auction"}),a.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mb-3",children:o==="round_ou"?"Round O/U: round (1–6), participant (golfer), and N bids (user + guess). Strike = average of guesses. Lowest half short, rest long; paired at 50¢.":"Pars: select a line (e.g. O8.5), then enter each person’s bid price (%). Trade price = average of bids. Lowest half short, rest long."}),a.jsxs("form",{onSubmit:Be,className:"space-y-3",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Market type"}),a.jsxs("select",{value:o,onChange:e=>ke(e.target.value),className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"round_ou",children:"Round O/U"}),a.jsx("option",{value:"pars",children:"Pars (e.g. Boose Pars)"})]})]}),o==="round_ou"&&a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Round"}),a.jsx("select",{value:Z,onChange:e=>je(Number(e.target.value)),className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[1,2,3,4,5,6].map(e=>a.jsxs("option",{value:e,children:["Round ",e]},e))})]}),o==="round_ou"&&a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Participant"}),a.jsxs("select",{value:B,onChange:e=>ve(e.target.value),required:!0,className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select participant"}),ce.map(e=>a.jsx("option",{value:e.id,children:e.name},e.id))]})]}),o==="pars"&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Line"}),a.jsxs("select",{value:p||"",onChange:e=>{const r=e.target.value;_e(r),r||ee("")},className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select line"}),b.filter(e=>e.market_type==="pars"||e.short_name&&e.short_name.toLowerCase().includes("pars")).flatMap(e=>(e.outcomes??[]).map(r=>({outcome_id:r.outcome_id,market_id:e.market_id,label:r.strike!=null&&r.strike!==""?`O${r.strike}`:r.name??r.outcome_id}))).map(e=>a.jsx("option",{value:e.outcome_id,children:e.label},e.outcome_id)),a.jsx("option",{value:"__new__",children:"— New line (strike from bid average) —"})]})]}),o==="pars"&&p==="__new__"&&a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Market (for new line)"}),a.jsxs("select",{value:P,onChange:e=>ee(e.target.value),className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select market"}),b.filter(e=>e.market_type==="pars"||e.short_name&&e.short_name.toLowerCase().includes("pars")).map(e=>a.jsx("option",{value:e.market_id,children:e.short_name},e.market_id))]})]})]}),a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center justify-between mb-1",children:[a.jsx("label",{className:"block text-sm font-medium",children:"Bids (min 2)"}),a.jsx("button",{type:"button",onClick:Me,className:"text-sm text-primary-600 dark:text-primary-400 hover:underline",children:"Add bid"})]}),a.jsx("div",{className:"space-y-2",children:h.map((e,r)=>a.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[a.jsxs("select",{value:e.user_id||"",onChange:t=>te(r,"user_id",Number(t.target.value)||0),className:"flex-1 min-w-[120px] border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"User"}),x.map(t=>a.jsx("option",{value:t.id,children:t.username},t.id))]}),a.jsx("input",{type:"number",step:"any",min:o==="pars"?0:void 0,max:o==="pars"?100:void 0,value:e.guess,onChange:t=>te(r,"guess",t.target.value),placeholder:o==="pars"?"Bid %":"Guess",className:"w-20 border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm"}),h.length>2&&a.jsx("button",{type:"button",onClick:()=>Re(r),className:"p-1.5 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded","aria-label":"Remove bid",children:"×"})]},r))})]}),a.jsx("button",{type:"submit",disabled:ae,className:"px-3 py-2 text-sm font-medium bg-primary-600 text-white rounded-md hover:bg-primary-700 disabled:opacity-50",children:ae?"Running…":"Run auction"})]})]})}),a.jsx(ne,{isOpen:pe,onClose:()=>N(!1),onConfirm:we,title:"Cancel all open orders",message:"Cancel all open/partial orders for every user? This cannot be undone.",confirmLabel:"Cancel all",variant:"danger"}),a.jsx(ne,{isOpen:he,onClose:()=>{w(!1),C(null)},onConfirm:Ce,title:"Cancel all orders for this user",message:m!=null?`Cancel all open/partial orders for user ${x.find(e=>e.id===m)?.username??m}?`:"",confirmLabel:"Cancel all",variant:"danger"}),a.jsx(Le,{toasts:de,removeToast:oe})]})}export{ze as AdminPage};
