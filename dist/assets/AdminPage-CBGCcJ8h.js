import{u as ke,a as je,r as n,b as u,j as a,N as ve}from"./index-nBe7qx8B.js";import{C as h,b as y}from"./Card-DopjO2gz.js";import{u as Ne,T as Ce}from"./Toast-CJ3Y3hPO.js";import{C as Q}from"./ConfirmModal-BmozI7BR.js";const V=3e3;let M=0;function Be(){const{user:x}=ke(),B=je(),{toasts:X,showToast:d,removeToast:Y}=Ne(),f=n.useRef(!1),[m,Z]=n.useState([]),[k,R]=n.useState([]),[ee,ae]=n.useState([]),[re,T]=n.useState(!1),[te,j]=n.useState(!1),[se,v]=n.useState(!1),[o,N]=n.useState(null),[O,U]=n.useState(!1),[I,P]=n.useState(!1),[ne,F]=n.useState({}),[E,$]=n.useState(!1),[b,le]=n.useState(""),[p,de]=n.useState(""),[g,ie]=n.useState(""),[C,L]=n.useState(""),[q,oe]=n.useState("bid"),[w,D]=n.useState(""),[S,z]=n.useState(""),[G,ce]=n.useState(1),[_,ue]=n.useState(""),[c,A]=n.useState([{user_id:0,guess:""},{user_id:0,guess:""}]),[H,W]=n.useState(!1);if(n.useEffect(()=>{if(!x?.admin||f.current)return;const e=Date.now();if(e-M<V)return;f.current=!0,M=e;let r=!1;return T(!0),Promise.all([u.adminGetUsers(),u.getMarkets(),u.getParticipants()]).then(([t,l,s])=>{r||(Z(t.users??[]),R(l.markets??[]),ae((s.participants??[]).map(i=>({id:i.id??i.name,name:i.name}))))}).catch(()=>{r||(f.current=!1,d("Failed to load admin data","error"))}).finally(()=>{r||T(!1)}),()=>{r=!0,setTimeout(()=>{M=0},V+500)}},[x?.admin]),x&&!x.admin)return a.jsx(ve,{to:"/markets",replace:!0});const me=k.find(e=>e.market_id===g)?.outcomes??[];async function xe(){U(!0);try{const{canceled:e}=await u.adminCancelAllOrders();d(`${e} order(s) canceled`,"success")}catch(e){d(e instanceof Error?e.message:"Failed to cancel orders","error")}finally{U(!1),j(!1)}}async function be(){if(o!=null){P(!0);try{const{canceled:e}=await u.adminCancelAllOrders(o),r=m.find(t=>t.id===o);d(`${e} order(s) canceled for ${r?.username??o}`,"success")}catch(e){d(e instanceof Error?e.message:"Failed to cancel orders","error")}finally{P(!1),v(!1),N(null)}}}async function pe(e,r){F(t=>({...t,[e]:!0}));try{await u.adminUpdateMarketPause(e,r),R(t=>t.map(l=>l.market_id===e?{...l,trading_paused:r?1:0}:l)),d(r?"Market paused":"Market resumed","success")}catch(t){d(t instanceof Error?t.message:"Failed to update market","error")}finally{F(t=>({...t,[e]:!1}))}}async function ge(e){e.preventDefault();const r=b===""?null:Number(b),t=p===""?null:Number(p),l=w.trim()?parseInt(w,10):NaN,s=S.trim()?parseInt(S,10):NaN;if(r==null||!g||!C||Number.isNaN(l)||l<100||l>9900||Number.isNaN(s)||s<1){d("Fill required fields: taker, market, outcome, price (100–9900), contracts (≥1)","error");return}$(!0);try{await u.adminCreateManualTrade({taker_user_id:r,maker_user_id:t??void 0,market_id:g,outcome_id:C,side:q,price:l,contract_size:s}),d("Manual trade created","success"),D(""),z("")}catch(i){d(i instanceof Error?i.message:"Failed to create manual trade","error")}finally{$(!1)}}function he(){A(e=>[...e,{user_id:0,guess:""}])}function ye(e){A(r=>r.filter((t,l)=>l!==e))}function J(e,r,t){A(l=>l.map((s,i)=>i===e?{...s,[r]:t}:s))}async function fe(e){if(e.preventDefault(),c.length<2){d("At least 2 bids are required","error");return}const r=c.map(s=>s.user_id);if(r.some((s,i)=>s!==0&&r.indexOf(s)!==i)){d("Duplicate user in bids; each user may only appear once","error");return}const l=[];for(let s=0;s<c.length;s++){const i=c[s].user_id,K=c[s].guess.trim()?parseFloat(c[s].guess):NaN;if(!i||Number.isNaN(K)){d(`Bid ${s+1}: select user and enter a numeric guess`,"error");return}l.push({user_id:i,guess:K})}if(!_){d("Select a participant","error");return}W(!0);try{const s=await u.adminRunRoundOuAuction({round:G,participant_id:_,bids:l});d(`Auction done. Strike: ${s.strike}. ${s.trades_created} trade(s) created.`,"success"),B(`/markets/${s.market_id}`)}catch(s){d(s instanceof Error?s.message:"Failed to run auction","error")}finally{W(!1)}}return a.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[a.jsx("div",{className:"flex items-center gap-2 sm:gap-4",children:a.jsxs("button",{onClick:()=>B("/markets"),className:"flex items-center gap-2 px-3 sm:px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary-600 dark:hover:text-primary-400 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-800 transition touch-manipulation",children:[a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),a.jsx("span",{className:"hidden sm:inline",children:"Back"})]})}),a.jsx("h1",{className:"text-xl sm:text-2xl font-bold",children:"Admin"}),a.jsx(h,{children:a.jsxs(y,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Cancel orders"}),a.jsxs("div",{className:"flex flex-wrap gap-3 items-center",children:[a.jsx("button",{type:"button",onClick:()=>j(!0),disabled:O,className:"px-3 py-2 text-sm font-medium bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50",children:O?"Canceling…":"Cancel all open orders (all users)"}),a.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:"or for user:"}),a.jsxs("select",{value:o??"",onChange:e=>N(e.target.value?Number(e.target.value):null),className:"border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select user"}),m.map(e=>a.jsxs("option",{value:e.id,children:[e.username," (id: ",e.id,")"]},e.id))]}),a.jsx("button",{type:"button",onClick:()=>o!=null&&v(!0),disabled:o==null||I,className:"px-3 py-2 text-sm font-medium bg-amber-600 text-white rounded-md hover:bg-amber-700 disabled:opacity-50",children:I?"Canceling…":"Cancel all for this user"})]})]})}),a.jsx(h,{children:a.jsxs(y,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Pause / resume trading by market"}),re?a.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading markets…"}):a.jsx("ul",{className:"space-y-2",children:k.map(e=>{const r=(e.trading_paused??0)===1,t=ne[e.market_id];return a.jsxs("li",{className:"flex items-center justify-between gap-2 py-2 border-b border-gray-200 dark:border-gray-700 last:border-0",children:[a.jsx("span",{className:"text-sm font-medium truncate",children:e.short_name}),a.jsx("button",{type:"button",onClick:()=>pe(e.market_id,!r),disabled:t,className:`px-3 py-1.5 text-sm font-medium rounded-md disabled:opacity-50 ${r?"bg-green-600 text-white hover:bg-green-700":"bg-gray-500 text-white hover:bg-gray-600"}`,children:t?"…":r?"Resume":"Pause"})]},e.market_id)})})]})}),a.jsx(h,{children:a.jsxs(y,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Add manual trade"}),a.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mb-3",children:"Record a trade like normal matching: taker is the one who took (placed the crossing order); maker is whose order was hit. Side is the taker's side (bid = buy, ask = sell). Both positions are updated when maker is set."}),a.jsxs("form",{onSubmit:ge,className:"space-y-3",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Taker (required)"}),a.jsxs("select",{value:b===""?"":b,onChange:e=>le(e.target.value?Number(e.target.value):""),required:!0,className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select taker"}),m.map(e=>a.jsxs("option",{value:e.id,children:[e.username," (id: ",e.id,")"]},e.id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Maker (optional)"}),a.jsxs("select",{value:p===""?"":String(p),onChange:e=>de(e.target.value?Number(e.target.value):""),className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"None (house / system)"}),m.map(e=>a.jsxs("option",{value:e.id,children:[e.username," (id: ",e.id,")"]},e.id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Market"}),a.jsxs("select",{value:g,onChange:e=>{ie(e.target.value),L("")},required:!0,className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select market"}),k.map(e=>a.jsx("option",{value:e.market_id,children:e.short_name},e.market_id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Outcome"}),a.jsxs("select",{value:C,onChange:e=>L(e.target.value),required:!0,className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select outcome"}),me.map(e=>a.jsx("option",{value:e.outcome_id,children:e.name},e.outcome_id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Taker side"}),a.jsxs("select",{value:q,onChange:e=>oe(e.target.value),className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"bid",children:"Bid (taker bought)"}),a.jsx("option",{value:"ask",children:"Ask (taker sold)"})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Price (cents, 100–9900)"}),a.jsx("input",{type:"number",min:100,max:9900,value:w,onChange:e=>D(e.target.value),placeholder:"e.g. 5000",className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Contract size"}),a.jsx("input",{type:"number",min:1,value:S,onChange:e=>z(e.target.value),placeholder:"e.g. 10",className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm"})]}),a.jsx("button",{type:"submit",disabled:E,className:"px-3 py-2 text-sm font-medium bg-primary-600 text-white rounded-md hover:bg-primary-700 disabled:opacity-50",children:E?"Creating…":"Add manual trade"})]})]})}),a.jsx(h,{children:a.jsxs(y,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Round O/U auction"}),a.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mb-3",children:"Run an auction: enter round (1–6), participant (golfer), and N bids (user + guess). Strike = average of guesses. Lowest half are short, rest long; paired trades at 50¢."}),a.jsxs("form",{onSubmit:fe,className:"space-y-3",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Round"}),a.jsx("select",{value:G,onChange:e=>ce(Number(e.target.value)),className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[1,2,3,4,5,6].map(e=>a.jsxs("option",{value:e,children:["Round ",e]},e))})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Participant"}),a.jsxs("select",{value:_,onChange:e=>ue(e.target.value),required:!0,className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select participant"}),ee.map(e=>a.jsx("option",{value:e.id,children:e.name},e.id))]})]}),a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center justify-between mb-1",children:[a.jsx("label",{className:"block text-sm font-medium",children:"Bids (min 2)"}),a.jsx("button",{type:"button",onClick:he,className:"text-sm text-primary-600 dark:text-primary-400 hover:underline",children:"Add bid"})]}),a.jsx("div",{className:"space-y-2",children:c.map((e,r)=>a.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[a.jsxs("select",{value:e.user_id||"",onChange:t=>J(r,"user_id",Number(t.target.value)||0),className:"flex-1 min-w-[120px] border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"User"}),m.map(t=>a.jsx("option",{value:t.id,children:t.username},t.id))]}),a.jsx("input",{type:"number",step:"any",value:e.guess,onChange:t=>J(r,"guess",t.target.value),placeholder:"Guess",className:"w-20 border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm"}),c.length>2&&a.jsx("button",{type:"button",onClick:()=>ye(r),className:"p-1.5 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded","aria-label":"Remove bid",children:"×"})]},r))})]}),a.jsx("button",{type:"submit",disabled:H,className:"px-3 py-2 text-sm font-medium bg-primary-600 text-white rounded-md hover:bg-primary-700 disabled:opacity-50",children:H?"Running…":"Run auction"})]})]})}),a.jsx(Q,{isOpen:te,onClose:()=>j(!1),onConfirm:xe,title:"Cancel all open orders",message:"Cancel all open/partial orders for every user? This cannot be undone.",confirmLabel:"Cancel all",variant:"danger"}),a.jsx(Q,{isOpen:se,onClose:()=>{v(!1),N(null)},onConfirm:be,title:"Cancel all orders for this user",message:o!=null?`Cancel all open/partial orders for user ${m.find(e=>e.id===o)?.username??o}?`:"",confirmLabel:"Cancel all",variant:"danger"}),a.jsx(Ce,{toasts:X,removeToast:Y})]})}export{Be as AdminPage};
