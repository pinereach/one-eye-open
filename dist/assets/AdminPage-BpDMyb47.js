import{u as ne,a as le,r,b as o,j as a,N as de}from"./index-1EVfI4dx.js";import{C as N,b as C}from"./Card-Cl9n6hfx.js";import{u as oe,T as ie}from"./Toast-BDGeCV5x.js";import{C as q}from"./ConfirmModal-mhPfA-wj.js";const $=3e3;let w=0;function he(){const{user:c}=ne(),D=le(),{toasts:z,showToast:n,removeToast:H}=oe(),b=r.useRef(!1),[i,G]=r.useState([]),[h,M]=r.useState([]),[W,S]=r.useState(!1),[J,g]=r.useState(!1),[K,p]=r.useState(!1),[l,f]=r.useState(null),[_,A]=r.useState(!1),[T,O]=r.useState(!1),[Q,U]=r.useState({}),[B,I]=r.useState(!1),[u,V]=r.useState(""),[m,X]=r.useState(""),[x,Y]=r.useState(""),[y,F]=r.useState(""),[E,Z]=r.useState("bid"),[k,P]=r.useState(""),[j,L]=r.useState("");if(r.useEffect(()=>{if(!c?.admin||b.current)return;const e=Date.now();if(e-w<$)return;b.current=!0,w=e;let s=!1;return S(!0),Promise.all([o.adminGetUsers(),o.getMarkets()]).then(([t,d])=>{s||(G(t.users??[]),M(d.markets??[]))}).catch(()=>{s||(b.current=!1,n("Failed to load admin data","error"))}).finally(()=>{s||S(!1)}),()=>{s=!0,setTimeout(()=>{w=0},$+500)}},[c?.admin]),c&&!c.admin)return a.jsx(de,{to:"/markets",replace:!0});const ee=h.find(e=>e.market_id===x)?.outcomes??[];async function ae(){A(!0);try{const{canceled:e}=await o.adminCancelAllOrders();n(`${e} order(s) canceled`,"success")}catch(e){n(e instanceof Error?e.message:"Failed to cancel orders","error")}finally{A(!1),g(!1)}}async function re(){if(l!=null){O(!0);try{const{canceled:e}=await o.adminCancelAllOrders(l),s=i.find(t=>t.id===l);n(`${e} order(s) canceled for ${s?.username??l}`,"success")}catch(e){n(e instanceof Error?e.message:"Failed to cancel orders","error")}finally{O(!1),p(!1),f(null)}}}async function se(e,s){U(t=>({...t,[e]:!0}));try{await o.adminUpdateMarketPause(e,s),M(t=>t.map(d=>d.market_id===e?{...d,trading_paused:s?1:0}:d)),n(s?"Market paused":"Market resumed","success")}catch(t){n(t instanceof Error?t.message:"Failed to update market","error")}finally{U(t=>({...t,[e]:!1}))}}async function te(e){e.preventDefault();const s=u===""?null:Number(u),t=m===""?null:Number(m),d=k.trim()?parseInt(k,10):NaN,v=j.trim()?parseInt(j,10):NaN;if(s==null||!x||!y||Number.isNaN(d)||d<100||d>9900||Number.isNaN(v)||v<1){n("Fill required fields: taker, market, outcome, price (100–9900), contracts (≥1)","error");return}I(!0);try{await o.adminCreateManualTrade({taker_user_id:s,maker_user_id:t??void 0,market_id:x,outcome_id:y,side:E,price:d,contract_size:v}),n("Manual trade created","success"),P(""),L("")}catch(R){n(R instanceof Error?R.message:"Failed to create manual trade","error")}finally{I(!1)}}return a.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[a.jsx("div",{className:"flex items-center gap-2 sm:gap-4",children:a.jsxs("button",{onClick:()=>D("/markets"),className:"flex items-center gap-2 px-3 sm:px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary-600 dark:hover:text-primary-400 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-800 transition touch-manipulation",children:[a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),a.jsx("span",{className:"hidden sm:inline",children:"Back"})]})}),a.jsx("h1",{className:"text-xl sm:text-2xl font-bold",children:"Admin"}),a.jsx(N,{children:a.jsxs(C,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Cancel orders"}),a.jsxs("div",{className:"flex flex-wrap gap-3 items-center",children:[a.jsx("button",{type:"button",onClick:()=>g(!0),disabled:_,className:"px-3 py-2 text-sm font-medium bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50",children:_?"Canceling…":"Cancel all open orders (all users)"}),a.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:"or for user:"}),a.jsxs("select",{value:l??"",onChange:e=>f(e.target.value?Number(e.target.value):null),className:"border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select user"}),i.map(e=>a.jsxs("option",{value:e.id,children:[e.username," (id: ",e.id,")"]},e.id))]}),a.jsx("button",{type:"button",onClick:()=>l!=null&&p(!0),disabled:l==null||T,className:"px-3 py-2 text-sm font-medium bg-amber-600 text-white rounded-md hover:bg-amber-700 disabled:opacity-50",children:T?"Canceling…":"Cancel all for this user"})]})]})}),a.jsx(N,{children:a.jsxs(C,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Pause / resume trading by market"}),W?a.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading markets…"}):a.jsx("ul",{className:"space-y-2",children:h.map(e=>{const s=(e.trading_paused??0)===1,t=Q[e.market_id];return a.jsxs("li",{className:"flex items-center justify-between gap-2 py-2 border-b border-gray-200 dark:border-gray-700 last:border-0",children:[a.jsx("span",{className:"text-sm font-medium truncate",children:e.short_name}),a.jsx("button",{type:"button",onClick:()=>se(e.market_id,!s),disabled:t,className:`px-3 py-1.5 text-sm font-medium rounded-md disabled:opacity-50 ${s?"bg-green-600 text-white hover:bg-green-700":"bg-gray-500 text-white hover:bg-gray-600"}`,children:t?"…":s?"Resume":"Pause"})]},e.market_id)})})]})}),a.jsx(N,{children:a.jsxs(C,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Add manual trade"}),a.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mb-3",children:"Record a trade like normal matching: taker is the one who took (placed the crossing order); maker is whose order was hit. Side is the taker's side (bid = buy, ask = sell). Both positions are updated when maker is set."}),a.jsxs("form",{onSubmit:te,className:"space-y-3",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Taker (required)"}),a.jsxs("select",{value:u===""?"":u,onChange:e=>V(e.target.value?Number(e.target.value):""),required:!0,className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select taker"}),i.map(e=>a.jsxs("option",{value:e.id,children:[e.username," (id: ",e.id,")"]},e.id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Maker (optional)"}),a.jsxs("select",{value:m===""?"":String(m),onChange:e=>X(e.target.value?Number(e.target.value):""),className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"None (house / system)"}),i.map(e=>a.jsxs("option",{value:e.id,children:[e.username," (id: ",e.id,")"]},e.id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Market"}),a.jsxs("select",{value:x,onChange:e=>{Y(e.target.value),F("")},required:!0,className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select market"}),h.map(e=>a.jsx("option",{value:e.market_id,children:e.short_name},e.market_id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Outcome"}),a.jsxs("select",{value:y,onChange:e=>F(e.target.value),required:!0,className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select outcome"}),ee.map(e=>a.jsx("option",{value:e.outcome_id,children:e.name},e.outcome_id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Taker side"}),a.jsxs("select",{value:E,onChange:e=>Z(e.target.value),className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"bid",children:"Bid (taker bought)"}),a.jsx("option",{value:"ask",children:"Ask (taker sold)"})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Price (cents, 100–9900)"}),a.jsx("input",{type:"number",min:100,max:9900,value:k,onChange:e=>P(e.target.value),placeholder:"e.g. 5000",className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Contract size"}),a.jsx("input",{type:"number",min:1,value:j,onChange:e=>L(e.target.value),placeholder:"e.g. 10",className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm"})]}),a.jsx("button",{type:"submit",disabled:B,className:"px-3 py-2 text-sm font-medium bg-primary-600 text-white rounded-md hover:bg-primary-700 disabled:opacity-50",children:B?"Creating…":"Add manual trade"})]})]})}),a.jsx(q,{isOpen:J,onClose:()=>g(!1),onConfirm:ae,title:"Cancel all open orders",message:"Cancel all open/partial orders for every user? This cannot be undone.",confirmLabel:"Cancel all",variant:"danger"}),a.jsx(q,{isOpen:K,onClose:()=>{p(!1),f(null)},onConfirm:re,title:"Cancel all orders for this user",message:l!=null?`Cancel all open/partial orders for user ${i.find(e=>e.id===l)?.username??l}?`:"",confirmLabel:"Cancel all",variant:"danger"}),a.jsx(ie,{toasts:z,removeToast:H})]})}export{he as AdminPage};
