import{u as le,a as ne,r as s,b as o,j as a,N as de}from"./index-cjRAL4_T.js";import{C as x,b as h}from"./Card-QMt2C_OP.js";import{u as oe,T as ce}from"./Toast-DctkrO_z.js";import{C as V}from"./ConfirmModal-C55gOaD0.js";const $=3e3;let C=0;function be(){const{user:c}=le(),q=ne(),{toasts:D,showToast:l,removeToast:z}=oe(),b=s.useRef(!1),[i,H]=s.useState([]),[p,N]=s.useState([]),[G,w]=s.useState(!1),[W,g]=s.useState(!1),[J,f]=s.useState(!1),[n,y]=s.useState(null),[M,S]=s.useState(!1),[_,A]=s.useState(!1),[K,T]=s.useState({}),[O,B]=s.useState(!1),[R,U]=s.useState(!1),[u,Q]=s.useState(""),[m,X]=s.useState(""),[j,F]=s.useState(""),[E,Y]=s.useState("bid"),[k,P]=s.useState(""),[v,I]=s.useState("");if(s.useEffect(()=>{if(!c?.admin||b.current)return;const e=Date.now();if(e-C<$)return;b.current=!0,C=e;let t=!1;return w(!0),Promise.all([o.adminGetUsers(),o.getMarkets()]).then(([r,d])=>{t||(H(r.users??[]),N(d.markets??[]))}).catch(()=>{t||(b.current=!1,l("Failed to load admin data","error"))}).finally(()=>{t||w(!1)}),()=>{t=!0,setTimeout(()=>{C=0},$+500)}},[c?.admin]),c&&!c.admin)return a.jsx(de,{to:"/markets",replace:!0});const Z=p.find(e=>e.market_id===m)?.outcomes??[];async function ee(){S(!0);try{const{canceled:e}=await o.adminCancelAllOrders();l(`${e} order(s) canceled`,"success")}catch(e){l(e instanceof Error?e.message:"Failed to cancel orders","error")}finally{S(!1),g(!1)}}async function ae(){if(n!=null){A(!0);try{const{canceled:e}=await o.adminCancelAllOrders(n),t=i.find(r=>r.id===n);l(`${e} order(s) canceled for ${t?.username??n}`,"success")}catch(e){l(e instanceof Error?e.message:"Failed to cancel orders","error")}finally{A(!1),f(!1),y(null)}}}async function re(){U(!0);try{const{updated:e}=await o.adminRefreshVolume();l(`Volume cache updated (${e} markets). Run every 4h via cron.`,"success")}catch(e){l(e instanceof Error?e.message:"Failed to refresh volume","error")}finally{U(!1)}}async function se(e,t){T(r=>({...r,[e]:!0}));try{await o.adminUpdateMarketPause(e,t),N(r=>r.map(d=>d.market_id===e?{...d,trading_paused:t?1:0}:d)),l(t?"Market paused":"Market resumed","success")}catch(r){l(r instanceof Error?r.message:"Failed to update market","error")}finally{T(r=>({...r,[e]:!1}))}}async function te(e){e.preventDefault();const t=u===""?null:Number(u),r=k.trim()?parseInt(k,10):NaN,d=v.trim()?parseInt(v,10):NaN;if(t==null||!m||!j||Number.isNaN(r)||r<100||r>9900||Number.isNaN(d)||d<1){l("Fill all fields: user, market, outcome, price (100–9900), contracts (≥1)","error");return}B(!0);try{await o.adminCreateManualTrade({user_id:t,market_id:m,outcome_id:j,side:E,price:r,contract_size:d}),l("Manual trade created","success"),P(""),I("")}catch(L){l(L instanceof Error?L.message:"Failed to create manual trade","error")}finally{B(!1)}}return a.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[a.jsx("div",{className:"flex items-center gap-2 sm:gap-4",children:a.jsxs("button",{onClick:()=>q("/markets"),className:"flex items-center gap-2 px-3 sm:px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary-600 dark:hover:text-primary-400 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-800 transition touch-manipulation",children:[a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),a.jsx("span",{className:"hidden sm:inline",children:"Back"})]})}),a.jsx("h1",{className:"text-xl sm:text-2xl font-bold",children:"Admin"}),a.jsx(x,{children:a.jsxs(h,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Cancel orders"}),a.jsxs("div",{className:"flex flex-wrap gap-3 items-center",children:[a.jsx("button",{type:"button",onClick:()=>g(!0),disabled:M,className:"px-3 py-2 text-sm font-medium bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50",children:M?"Canceling…":"Cancel all open orders (all users)"}),a.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:"or for user:"}),a.jsxs("select",{value:n??"",onChange:e=>y(e.target.value?Number(e.target.value):null),className:"border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select user"}),i.map(e=>a.jsxs("option",{value:e.id,children:[e.username," (id: ",e.id,")"]},e.id))]}),a.jsx("button",{type:"button",onClick:()=>n!=null&&f(!0),disabled:n==null||_,className:"px-3 py-2 text-sm font-medium bg-amber-600 text-white rounded-md hover:bg-amber-700 disabled:opacity-50",children:_?"Canceling…":"Cancel all for this user"})]})]})}),a.jsx(x,{children:a.jsxs(h,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Volume cache"}),a.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mb-2",children:"Markets list reads volume from cache. Refresh every 4h (or run via cron to POST /api/admin/refresh-volume)."}),a.jsx("button",{type:"button",onClick:re,disabled:R,className:"px-3 py-2 text-sm font-medium bg-primary-600 text-white rounded-md hover:bg-primary-700 disabled:opacity-50",children:R?"Refreshing…":"Refresh volume cache"})]})}),a.jsx(x,{children:a.jsxs(h,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Pause / resume trading by market"}),G?a.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading markets…"}):a.jsx("ul",{className:"space-y-2",children:p.map(e=>{const t=(e.trading_paused??0)===1,r=K[e.market_id];return a.jsxs("li",{className:"flex items-center justify-between gap-2 py-2 border-b border-gray-200 dark:border-gray-700 last:border-0",children:[a.jsx("span",{className:"text-sm font-medium truncate",children:e.short_name}),a.jsx("button",{type:"button",onClick:()=>se(e.market_id,!t),disabled:r,className:`px-3 py-1.5 text-sm font-medium rounded-md disabled:opacity-50 ${t?"bg-green-600 text-white hover:bg-green-700":"bg-gray-500 text-white hover:bg-gray-600"}`,children:r?"…":t?"Resume":"Pause"})]},e.market_id)})})]})}),a.jsx(x,{children:a.jsxs(h,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Add manual trade"}),a.jsxs("form",{onSubmit:te,className:"space-y-3",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"User"}),a.jsxs("select",{value:u===""?"":u,onChange:e=>Q(e.target.value?Number(e.target.value):""),required:!0,className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select user"}),i.map(e=>a.jsxs("option",{value:e.id,children:[e.username," (id: ",e.id,")"]},e.id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Market"}),a.jsxs("select",{value:m,onChange:e=>{X(e.target.value),F("")},required:!0,className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select market"}),p.map(e=>a.jsx("option",{value:e.market_id,children:e.short_name},e.market_id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Outcome"}),a.jsxs("select",{value:j,onChange:e=>F(e.target.value),required:!0,className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select outcome"}),Z.map(e=>a.jsx("option",{value:e.outcome_id,children:e.name},e.outcome_id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Side"}),a.jsxs("select",{value:E,onChange:e=>Y(e.target.value),className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"bid",children:"Bid (buy)"}),a.jsx("option",{value:"ask",children:"Ask (sell)"})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Price (cents, 100–9900)"}),a.jsx("input",{type:"number",min:100,max:9900,value:k,onChange:e=>P(e.target.value),placeholder:"e.g. 5000",className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Contract size"}),a.jsx("input",{type:"number",min:1,value:v,onChange:e=>I(e.target.value),placeholder:"e.g. 10",className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm"})]}),a.jsx("button",{type:"submit",disabled:O,className:"px-3 py-2 text-sm font-medium bg-primary-600 text-white rounded-md hover:bg-primary-700 disabled:opacity-50",children:O?"Creating…":"Add manual trade"})]})]})}),a.jsx(V,{isOpen:W,onClose:()=>g(!1),onConfirm:ee,title:"Cancel all open orders",message:"Cancel all open/partial orders for every user? This cannot be undone.",confirmLabel:"Cancel all",variant:"danger"}),a.jsx(V,{isOpen:J,onClose:()=>{f(!1),y(null)},onConfirm:ae,title:"Cancel all orders for this user",message:n!=null?`Cancel all open/partial orders for user ${i.find(e=>e.id===n)?.username??n}?`:"",confirmLabel:"Cancel all",variant:"danger"}),a.jsx(ce,{toasts:D,removeToast:z})]})}export{be as AdminPage};
