import{u as U,r as i,j as e,N as D,b as E}from"./index-1EVfI4dx.js";import{C as A,b as F}from"./Card-Cl9n6hfx.js";import{P as R}from"./PullToRefresh-UgsvgPCs.js";function n(p,a=!1){const j=p/100,y=Math.abs(j).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});return a?p>=0?`+$${y}`:`-$${y}`:`$${y}`}const B="shares_traded",M="desc";function I(){const{user:p}=U(),[a,j]=i.useState([]),[l,y]=i.useState(0),[x,C]=i.useState(0),[f,L]=i.useState({}),[k,T]=i.useState([]),[P,N]=i.useState(!0),[_,v]=i.useState(null),[o,O]=i.useState(B),[c,S]=i.useState(M),b=i.useMemo(()=>{if(a.length===0)return[];const t=o,r=c==="asc"?1:-1;return[...a].sort((d,s)=>{let m=0;if(t==="username")m=(d.username??"").localeCompare(s.username??"");else{const g=t==="portfolio_value_cents"?d.portfolio_value_cents:t==="trade_count"?d.trade_count:t==="open_orders_count"?d.open_orders_count:d.shares_traded,u=t==="portfolio_value_cents"?s.portfolio_value_cents:t==="trade_count"?s.trade_count:t==="open_orders_count"?s.open_orders_count:s.shares_traded;m=g-u}return m*r})},[a,o,c]);function h(t){o===t?S(r=>r==="asc"?"desc":"asc"):(O(t),S(t==="username"?"asc":"desc"))}async function $(){N(!0),v(null);try{const{leaderboard:t,unattributed_portfolio_value_cents:r,system_total_portfolio_value_cents:d,pnl_by_outcome:s,position_contributions:m}=await E.adminGetLeaderboard();j(t??[]),y(r??0),C(d??0),L(s??{}),T(m??[])}catch(t){console.error("Failed to load leaderboard:",t),v(t instanceof Error?t.message:"Failed to load leaderboard")}finally{N(!1)}}return i.useEffect(()=>{p?.admin&&$()},[p?.admin]),p&&!p.admin?e.jsx(D,{to:"/markets",replace:!0}):P&&a.length===0?e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-gray-900 dark:text-gray-100",children:"Leaderboard"}),e.jsx("div",{className:"animate-pulse space-y-2",children:[1,2,3,4,5].map(t=>e.jsx("div",{className:"h-14 bg-gray-200 dark:bg-gray-700 rounded-lg"},t))})]}):_?e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-gray-900 dark:text-gray-100",children:"Leaderboard"}),e.jsx("p",{className:"text-sm text-red-600 dark:text-red-400",children:_})]}):e.jsx(R,{onRefresh:$,children:e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-gray-900 dark:text-gray-100",children:"Leaderboard"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Per-user stats: trades, open orders, shares traded, portfolio value (P&L). Zero-sum: system total should be $0."}),a.length>0&&e.jsxs("div",{className:`rounded-lg border p-4 ${x===0?"border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800/80":"border-amber-400 dark:border-amber-500 bg-amber-50 dark:bg-amber-900/20"}`,children:[e.jsx("div",{className:"text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1",children:"Debug checks"}),e.jsxs("div",{className:"flex flex-wrap gap-x-6 gap-y-1 text-sm",children:[e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"System total (sum of all position P&L):"})," ",e.jsx("span",{className:`font-semibold ${x===0?"text-green-600 dark:text-green-400":"text-amber-600 dark:text-amber-400"}`,children:n(x,!0)}),x!==0&&e.jsx("span",{className:"ml-2 text-amber-600 dark:text-amber-400 text-xs",children:"(should be $0 — check trade/position logic)"})]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Users + Unattributed:"})," ",e.jsx("span",{className:`font-semibold ${a.reduce((t,r)=>t+r.portfolio_value_cents,0)+l===x?"text-green-600 dark:text-green-400":"text-amber-600 dark:text-amber-400"}`,children:n(a.reduce((t,r)=>t+r.portfolio_value_cents,0)+l,!0)}),a.reduce((t,r)=>t+r.portfolio_value_cents,0)+l!==x&&e.jsx("span",{className:"ml-2 text-amber-600 dark:text-amber-400 text-xs",children:"(should equal system total)"})]})]}),x!==0&&(Object.keys(f).length>0||k.length>0)&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-200 dark:border-gray-600",children:[e.jsx("div",{className:"text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-2",children:"Where the imbalance comes from"}),Object.keys(f).length>0&&e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"text-xs text-gray-600 dark:text-gray-400",children:"P&L by outcome (should be $0 per outcome in zero-sum):"}),e.jsx("ul",{className:"mt-1 space-y-0.5 text-sm font-mono",children:Object.entries(f).filter(([,t])=>t!==0).sort((t,r)=>Math.abs(r[1])-Math.abs(t[1])).map(([t,r])=>e.jsxs("li",{className:r>0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400",children:[t,": ",n(r,!0)]},t))})]}),k.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Top position contributions (user_id, outcome, P&L):"}),e.jsx("ul",{className:"mt-1 space-y-0.5 text-sm font-mono max-h-40 overflow-y-auto",children:k.slice(0,20).map((t,r)=>e.jsxs("li",{className:t.contribution_cents>0?"text-green-600 dark:text-green-400":t.contribution_cents<0?"text-red-600 dark:text-red-400":"text-gray-500 dark:text-gray-400",children:["user ",t.user_id??"null"," · ",t.outcome,": ",n(t.contribution_cents,!0)]},r))})]})]})]}),e.jsx("div",{className:"md:hidden space-y-3",children:b.length===0?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 py-4",children:"No users."}):b.map(t=>e.jsx(A,{children:e.jsxs(F,{className:"p-4",children:[e.jsx("div",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-3",children:t.username}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Trades"}),e.jsx("span",{className:"text-right font-medium",children:t.trade_count}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Open orders"}),e.jsx("span",{className:"text-right font-medium",children:t.open_orders_count}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Shares traded"}),e.jsx("span",{className:"text-right font-medium",children:t.shares_traded}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Portfolio value"}),e.jsx("span",{className:`text-right font-medium ${t.portfolio_value_cents>0?"text-green-600 dark:text-green-400":t.portfolio_value_cents<0?"text-red-600 dark:text-red-400":""}`,children:n(t.portfolio_value_cents,!0)})]})]})},t.user_id))}),a.length>0&&(()=>{const t=a.reduce((d,s)=>d+s.portfolio_value_cents,0),r=t+l;return e.jsxs("div",{className:"md:hidden rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800/80 p-4",children:[e.jsx("div",{className:"text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-2",children:"Summary (all participants)"}),e.jsxs("div",{className:"flex flex-wrap gap-x-6 gap-y-1 text-sm",children:[e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Trades:"})," ",e.jsx("span",{className:"font-semibold",children:a.reduce((d,s)=>d+s.trade_count,0)})]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Open orders:"})," ",e.jsx("span",{className:"font-semibold",children:a.reduce((d,s)=>d+s.open_orders_count,0)})]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Shares traded:"})," ",e.jsx("span",{className:"font-semibold",children:a.reduce((d,s)=>d+s.shares_traded,0)})]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Portfolio (users):"})," ",e.jsx("span",{className:`font-semibold ${t>0?"text-green-600 dark:text-green-400":t<0?"text-red-600 dark:text-red-400":"text-gray-700 dark:text-gray-300"}`,children:n(t,!0)})]}),l!==0&&e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Unattributed:"})," ",e.jsx("span",{className:`font-semibold ${l>0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:n(l,!0)})]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Total (users + unattributed):"})," ",e.jsx("span",{className:`font-semibold ${r===0?"text-gray-700 dark:text-gray-300":r>0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:n(r,!0)})]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"System total:"})," ",e.jsx("span",{className:`font-semibold ${x===0?"text-green-600 dark:text-green-400":"text-amber-600 dark:text-amber-400"}`,children:n(x,!0)})]})]})]})})(),e.jsx("div",{className:"hidden md:block overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-600",children:e.jsxs("table",{className:"w-full min-w-[600px] border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800",children:[e.jsx("th",{className:"py-3 px-4 text-left text-xs font-bold text-gray-600 dark:text-gray-400",children:e.jsxs("button",{type:"button",onClick:()=>h("username"),className:"flex items-center gap-1 hover:text-primary-600 dark:hover:text-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded","aria-sort":o==="username"?c==="asc"?"ascending":"descending":void 0,children:["User ",o==="username"&&(c==="asc"?"↑":"↓")]})}),e.jsx("th",{className:"py-3 px-4 text-right text-xs font-bold text-gray-600 dark:text-gray-400",children:e.jsxs("button",{type:"button",onClick:()=>h("trade_count"),className:"inline-flex items-center gap-1 ml-auto hover:text-primary-600 dark:hover:text-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded","aria-sort":o==="trade_count"?c==="asc"?"ascending":"descending":void 0,children:["Trades ",o==="trade_count"&&(c==="asc"?"↑":"↓")]})}),e.jsx("th",{className:"py-3 px-4 text-right text-xs font-bold text-gray-600 dark:text-gray-400",children:e.jsxs("button",{type:"button",onClick:()=>h("open_orders_count"),className:"inline-flex items-center gap-1 ml-auto hover:text-primary-600 dark:hover:text-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded","aria-sort":o==="open_orders_count"?c==="asc"?"ascending":"descending":void 0,children:["Open orders ",o==="open_orders_count"&&(c==="asc"?"↑":"↓")]})}),e.jsx("th",{className:"py-3 px-4 text-right text-xs font-bold text-gray-600 dark:text-gray-400",children:e.jsxs("button",{type:"button",onClick:()=>h("shares_traded"),className:"inline-flex items-center gap-1 ml-auto hover:text-primary-600 dark:hover:text-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded","aria-sort":o==="shares_traded"?c==="asc"?"ascending":"descending":void 0,children:["Shares traded ",o==="shares_traded"&&(c==="asc"?"↑":"↓")]})}),e.jsx("th",{className:"py-3 px-4 text-right text-xs font-bold text-gray-600 dark:text-gray-400",children:e.jsxs("button",{type:"button",onClick:()=>h("portfolio_value_cents"),className:"inline-flex items-center gap-1 ml-auto hover:text-primary-600 dark:hover:text-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded","aria-sort":o==="portfolio_value_cents"?c==="asc"?"ascending":"descending":void 0,children:["Portfolio value ",o==="portfolio_value_cents"&&(c==="asc"?"↑":"↓")]})})]})}),e.jsx("tbody",{children:b.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"py-8 text-center text-gray-500 dark:text-gray-400",children:"No users."})}):b.map(t=>e.jsxs("tr",{className:"border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800/50",children:[e.jsx("td",{className:"py-3 px-4 font-medium text-gray-900 dark:text-gray-100",children:t.username}),e.jsx("td",{className:"py-3 px-4 text-right text-gray-700 dark:text-gray-300",children:t.trade_count}),e.jsx("td",{className:"py-3 px-4 text-right text-gray-700 dark:text-gray-300",children:t.open_orders_count}),e.jsx("td",{className:"py-3 px-4 text-right text-gray-700 dark:text-gray-300",children:t.shares_traded}),e.jsx("td",{className:`py-3 px-4 text-right font-medium ${t.portfolio_value_cents>0?"text-green-600 dark:text-green-400":t.portfolio_value_cents<0?"text-red-600 dark:text-red-400":"text-gray-900 dark:text-gray-100"}`,children:n(t.portfolio_value_cents,!0)})]},t.user_id))}),a.length>0&&(()=>{const t=a.reduce((g,u)=>g+u.trade_count,0),r=a.reduce((g,u)=>g+u.open_orders_count,0),d=a.reduce((g,u)=>g+u.shares_traded,0),s=a.reduce((g,u)=>g+u.portfolio_value_cents,0),m=s+l;return e.jsxs("tfoot",{children:[e.jsxs("tr",{className:"border-t-2 border-gray-300 dark:border-gray-500 bg-gray-100 dark:bg-gray-800 font-semibold",children:[e.jsx("td",{className:"py-3 px-4 text-gray-900 dark:text-gray-100",children:"All participants"}),e.jsx("td",{className:"py-3 px-4 text-right",children:t}),e.jsx("td",{className:"py-3 px-4 text-right",children:r}),e.jsx("td",{className:"py-3 px-4 text-right",children:d}),e.jsx("td",{className:`py-3 px-4 text-right ${s>0?"text-green-600 dark:text-green-400":s<0?"text-red-600 dark:text-red-400":"text-gray-700 dark:text-gray-300"}`,children:n(s,!0)})]}),l!==0&&e.jsxs("tr",{className:"border-t border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800/80 font-medium",children:[e.jsx("td",{className:"py-2 px-4 text-gray-600 dark:text-gray-400 text-xs",children:"Unattributed (no user_id or deleted user)"}),e.jsx("td",{colSpan:3,className:"py-2 px-4"}),e.jsx("td",{className:`py-2 px-4 text-right ${l>0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:n(l,!0)})]}),e.jsxs("tr",{className:"border-t border-gray-300 dark:border-gray-500 bg-gray-100 dark:bg-gray-800 font-semibold",children:[e.jsx("td",{className:"py-3 px-4 text-gray-900 dark:text-gray-100",children:"Total (users + unattributed)"}),e.jsx("td",{colSpan:3,className:"py-3 px-4"}),e.jsx("td",{className:`py-3 px-4 text-right ${m===0?"text-gray-700 dark:text-gray-300":m>0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:n(m,!0)})]}),e.jsxs("tr",{className:"border-t border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800/80 font-medium",children:[e.jsx("td",{className:"py-2 px-4 text-gray-600 dark:text-gray-400 text-xs",children:"System total (all positions; should be $0)"}),e.jsx("td",{colSpan:3,className:"py-2 px-4"}),e.jsx("td",{className:`py-2 px-4 text-right font-semibold ${x===0?"text-green-600 dark:text-green-400":"text-amber-600 dark:text-amber-400"}`,children:n(x,!0)})]})]})})()]})})]})})}export{I as LeaderboardPage};
