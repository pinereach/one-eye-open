import{u as A,r as m,j as e,N as E,b as F}from"./index-nBe7qx8B.js";import{C as R,b as B}from"./Card-DopjO2gz.js";import{P as M}from"./PullToRefresh-DnciUTUm.js";function n(u,a=!1){const k=u/100,f=Math.abs(k).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});return a?u>=0?`+$${f}`:`-$${f}`:`$${f}`}const q="shares_traded",z="desc";function Z(){const{user:u}=A(),[a,k]=m.useState([]),[c,f]=m.useState(0),[i,T]=m.useState(0),[j,P]=m.useState({}),[N,O]=m.useState([]),[U,v]=m.useState(!0),[S,$]=m.useState(null),[o,D]=m.useState(q),[l,C]=m.useState(z),_=m.useMemo(()=>{if(a.length===0)return[];const t=o,d=l==="asc"?1:-1;return[...a].sort((s,r)=>{let p=0;if(t==="username")p=(s.username??"").localeCompare(r.username??"");else{const h=t==="portfolio_value_cents"?s.portfolio_value_cents:t==="closed_profit_cents"?s.closed_profit_cents:t==="settled_profit_cents"?s.settled_profit_cents:t==="trade_count"?s.trade_count:t==="open_orders_count"?s.open_orders_count:s.shares_traded,b=t==="portfolio_value_cents"?r.portfolio_value_cents:t==="closed_profit_cents"?r.closed_profit_cents:t==="settled_profit_cents"?r.settled_profit_cents:t==="trade_count"?r.trade_count:t==="open_orders_count"?r.open_orders_count:r.shares_traded;p=h-b}return p*d})},[a,o,l]);function y(t){o===t?C(d=>d==="asc"?"desc":"asc"):(D(t),C(t==="username"?"asc":"desc"))}async function L(){v(!0),$(null);try{const{leaderboard:t,unattributed_portfolio_value_cents:d,system_total_portfolio_value_cents:s,pnl_by_outcome:r,position_contributions:p}=await F.adminGetLeaderboard();k(t??[]),f(d??0),T(s??0),P(r??{}),O(p??[])}catch(t){console.error("Failed to load leaderboard:",t),$(t instanceof Error?t.message:"Failed to load leaderboard")}finally{v(!1)}}return m.useEffect(()=>{u?.admin&&L()},[u?.admin]),u&&!u.admin?e.jsx(E,{to:"/markets",replace:!0}):U&&a.length===0?e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-gray-900 dark:text-gray-100",children:"Leaderboard"}),e.jsx("div",{className:"animate-pulse space-y-2",children:[1,2,3,4,5].map(t=>e.jsx("div",{className:"h-14 bg-gray-200 dark:bg-gray-700 rounded-lg"},t))})]}):S?e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-gray-900 dark:text-gray-100",children:"Leaderboard"}),e.jsx("p",{className:"text-sm text-red-600 dark:text-red-400",children:S})]}):e.jsx(M,{onRefresh:L,children:e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-gray-900 dark:text-gray-100",children:"Leaderboard"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Per-user stats: trades, open orders, shares traded, closed profit, settled profit, portfolio value (P&L). Zero-sum: system total should be $0."}),a.length>0&&e.jsxs("div",{className:`rounded-lg border p-4 ${i===0?"border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800/80":"border-amber-400 dark:border-amber-500 bg-amber-50 dark:bg-amber-900/20"}`,children:[e.jsx("div",{className:"text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1",children:"Debug checks"}),e.jsxs("div",{className:"flex flex-wrap gap-x-6 gap-y-1 text-sm",children:[e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"System total (sum of all position P&L):"})," ",e.jsx("span",{className:`font-semibold ${i===0?"text-green-600 dark:text-green-400":"text-amber-600 dark:text-amber-400"}`,children:n(i,!0)}),i!==0&&e.jsx("span",{className:"ml-2 text-amber-600 dark:text-amber-400 text-xs",children:"(should be $0 — check trade/position logic)"})]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Users + Unattributed:"})," ",e.jsx("span",{className:`font-semibold ${a.reduce((t,d)=>t+d.portfolio_value_cents,0)+c===i?"text-green-600 dark:text-green-400":"text-amber-600 dark:text-amber-400"}`,children:n(a.reduce((t,d)=>t+d.portfolio_value_cents,0)+c,!0)}),a.reduce((t,d)=>t+d.portfolio_value_cents,0)+c!==i&&e.jsx("span",{className:"ml-2 text-amber-600 dark:text-amber-400 text-xs",children:"(should equal system total)"})]})]}),i!==0&&(Object.keys(j).length>0||N.length>0)&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-200 dark:border-gray-600",children:[e.jsx("div",{className:"text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-2",children:"Where the imbalance comes from"}),Object.keys(j).length>0&&e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"text-xs text-gray-600 dark:text-gray-400",children:"P&L by outcome (should be $0 per outcome in zero-sum):"}),e.jsx("ul",{className:"mt-1 space-y-0.5 text-sm font-mono",children:Object.entries(j).filter(([,t])=>t!==0).sort((t,d)=>Math.abs(d[1])-Math.abs(t[1])).map(([t,d])=>e.jsxs("li",{className:d>0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400",children:[t,": ",n(d,!0)]},t))})]}),N.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Top position contributions (user_id, outcome, P&L):"}),e.jsx("ul",{className:"mt-1 space-y-0.5 text-sm font-mono max-h-40 overflow-y-auto",children:N.slice(0,20).map((t,d)=>e.jsxs("li",{className:t.contribution_cents>0?"text-green-600 dark:text-green-400":t.contribution_cents<0?"text-red-600 dark:text-red-400":"text-gray-500 dark:text-gray-400",children:["user ",t.user_id??"null"," · ",t.outcome,": ",n(t.contribution_cents,!0)]},d))})]})]})]}),e.jsx("div",{className:"md:hidden space-y-3",children:_.length===0?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 py-4",children:"No users."}):_.map(t=>e.jsx(R,{children:e.jsxs(B,{className:"p-4",children:[e.jsx("div",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-3",children:t.username}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Trades"}),e.jsx("span",{className:"text-right font-medium",children:t.trade_count}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Open orders"}),e.jsx("span",{className:"text-right font-medium",children:t.open_orders_count}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Shares traded"}),e.jsx("span",{className:"text-right font-medium",children:t.shares_traded}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Closed profit"}),e.jsx("span",{className:`text-right font-medium ${t.closed_profit_cents>0?"text-green-600 dark:text-green-400":t.closed_profit_cents<0?"text-red-600 dark:text-red-400":""}`,children:n(t.closed_profit_cents,!0)}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Settled profit"}),e.jsx("span",{className:`text-right font-medium ${t.settled_profit_cents>0?"text-green-600 dark:text-green-400":t.settled_profit_cents<0?"text-red-600 dark:text-red-400":""}`,children:n(t.settled_profit_cents,!0)}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Portfolio value"}),e.jsx("span",{className:`text-right font-medium ${t.portfolio_value_cents>0?"text-green-600 dark:text-green-400":t.portfolio_value_cents<0?"text-red-600 dark:text-red-400":""}`,children:n(t.portfolio_value_cents,!0)})]})]})},t.user_id))}),a.length>0&&(()=>{const t=a.reduce((s,r)=>s+r.portfolio_value_cents,0),d=t+c;return e.jsxs("div",{className:"md:hidden rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800/80 p-4",children:[e.jsx("div",{className:"text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-2",children:"Summary (all participants)"}),e.jsxs("div",{className:"flex flex-wrap gap-x-6 gap-y-1 text-sm",children:[e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Trades:"})," ",e.jsx("span",{className:"font-semibold",children:a.reduce((s,r)=>s+r.trade_count,0)})]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Open orders:"})," ",e.jsx("span",{className:"font-semibold",children:a.reduce((s,r)=>s+r.open_orders_count,0)})]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Shares traded:"})," ",e.jsx("span",{className:"font-semibold",children:a.reduce((s,r)=>s+r.shares_traded,0)})]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Closed profit (users):"})," ",e.jsx("span",{className:`font-semibold ${a.reduce((s,r)=>s+r.closed_profit_cents,0)>0?"text-green-600 dark:text-green-400":a.reduce((s,r)=>s+r.closed_profit_cents,0)<0?"text-red-600 dark:text-red-400":"text-gray-700 dark:text-gray-300"}`,children:n(a.reduce((s,r)=>s+r.closed_profit_cents,0),!0)})]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Settled profit (users):"})," ",e.jsx("span",{className:`font-semibold ${a.reduce((s,r)=>s+r.settled_profit_cents,0)>0?"text-green-600 dark:text-green-400":a.reduce((s,r)=>s+r.settled_profit_cents,0)<0?"text-red-600 dark:text-red-400":"text-gray-700 dark:text-gray-300"}`,children:n(a.reduce((s,r)=>s+r.settled_profit_cents,0),!0)})]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Portfolio (users):"})," ",e.jsx("span",{className:`font-semibold ${t>0?"text-green-600 dark:text-green-400":t<0?"text-red-600 dark:text-red-400":"text-gray-700 dark:text-gray-300"}`,children:n(t,!0)})]}),c!==0&&e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Unattributed:"})," ",e.jsx("span",{className:`font-semibold ${c>0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:n(c,!0)})]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Total (users + unattributed):"})," ",e.jsx("span",{className:`font-semibold ${d===0?"text-gray-700 dark:text-gray-300":d>0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:n(d,!0)})]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"System total:"})," ",e.jsx("span",{className:`font-semibold ${i===0?"text-green-600 dark:text-green-400":"text-amber-600 dark:text-amber-400"}`,children:n(i,!0)})]})]})]})})(),e.jsx("div",{className:"hidden md:block overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-600",children:e.jsxs("table",{className:"w-full min-w-[700px] border-collapse","aria-describedby":"leaderboard-caption",children:[e.jsx("caption",{id:"leaderboard-caption",className:"sr-only",children:"Admin leaderboard: per-user stats including trades, open orders, shares traded, closed profit, settled profit, and portfolio value"}),e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800",children:[e.jsx("th",{className:"py-3 px-4 text-left text-xs font-bold text-gray-600 dark:text-gray-400",children:e.jsxs("button",{type:"button",onClick:()=>y("username"),className:"flex items-center gap-1 hover:text-primary-600 dark:hover:text-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded","aria-sort":o==="username"?l==="asc"?"ascending":"descending":void 0,children:["User ",o==="username"&&(l==="asc"?"↑":"↓")]})}),e.jsx("th",{className:"py-3 px-4 text-right text-xs font-bold text-gray-600 dark:text-gray-400",children:e.jsxs("button",{type:"button",onClick:()=>y("trade_count"),className:"inline-flex items-center gap-1 ml-auto hover:text-primary-600 dark:hover:text-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded","aria-sort":o==="trade_count"?l==="asc"?"ascending":"descending":void 0,children:["Trades ",o==="trade_count"&&(l==="asc"?"↑":"↓")]})}),e.jsx("th",{className:"py-3 px-4 text-right text-xs font-bold text-gray-600 dark:text-gray-400",children:e.jsxs("button",{type:"button",onClick:()=>y("open_orders_count"),className:"inline-flex items-center gap-1 ml-auto hover:text-primary-600 dark:hover:text-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded","aria-sort":o==="open_orders_count"?l==="asc"?"ascending":"descending":void 0,children:["Open orders ",o==="open_orders_count"&&(l==="asc"?"↑":"↓")]})}),e.jsx("th",{className:"py-3 px-4 text-right text-xs font-bold text-gray-600 dark:text-gray-400",children:e.jsxs("button",{type:"button",onClick:()=>y("shares_traded"),className:"inline-flex items-center gap-1 ml-auto hover:text-primary-600 dark:hover:text-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded","aria-sort":o==="shares_traded"?l==="asc"?"ascending":"descending":void 0,children:["Shares traded ",o==="shares_traded"&&(l==="asc"?"↑":"↓")]})}),e.jsx("th",{className:"py-3 px-4 text-right text-xs font-bold text-gray-600 dark:text-gray-400",children:e.jsxs("button",{type:"button",onClick:()=>y("closed_profit_cents"),className:"inline-flex items-center gap-1 ml-auto hover:text-primary-600 dark:hover:text-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded","aria-sort":o==="closed_profit_cents"?l==="asc"?"ascending":"descending":void 0,children:["Closed profit ",o==="closed_profit_cents"&&(l==="asc"?"↑":"↓")]})}),e.jsx("th",{className:"py-3 px-4 text-right text-xs font-bold text-gray-600 dark:text-gray-400",children:e.jsxs("button",{type:"button",onClick:()=>y("settled_profit_cents"),className:"inline-flex items-center gap-1 ml-auto hover:text-primary-600 dark:hover:text-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded","aria-sort":o==="settled_profit_cents"?l==="asc"?"ascending":"descending":void 0,children:["Settled profit ",o==="settled_profit_cents"&&(l==="asc"?"↑":"↓")]})}),e.jsx("th",{className:"py-3 px-4 text-right text-xs font-bold text-gray-600 dark:text-gray-400",children:e.jsxs("button",{type:"button",onClick:()=>y("portfolio_value_cents"),className:"inline-flex items-center gap-1 ml-auto hover:text-primary-600 dark:hover:text-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded","aria-sort":o==="portfolio_value_cents"?l==="asc"?"ascending":"descending":void 0,children:["Portfolio value ",o==="portfolio_value_cents"&&(l==="asc"?"↑":"↓")]})})]})}),e.jsx("tbody",{children:_.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"py-8 text-center text-gray-500 dark:text-gray-400",children:"No users."})}):_.map(t=>e.jsxs("tr",{className:"border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800/50",children:[e.jsx("td",{className:"py-3 px-4 font-medium text-gray-900 dark:text-gray-100",children:t.username}),e.jsx("td",{className:"py-3 px-4 text-right text-gray-700 dark:text-gray-300",children:t.trade_count}),e.jsx("td",{className:"py-3 px-4 text-right text-gray-700 dark:text-gray-300",children:t.open_orders_count}),e.jsx("td",{className:"py-3 px-4 text-right text-gray-700 dark:text-gray-300",children:t.shares_traded}),e.jsx("td",{className:`py-3 px-4 text-right font-medium ${t.closed_profit_cents>0?"text-green-600 dark:text-green-400":t.closed_profit_cents<0?"text-red-600 dark:text-red-400":"text-gray-900 dark:text-gray-100"}`,children:n(t.closed_profit_cents,!0)}),e.jsx("td",{className:`py-3 px-4 text-right font-medium ${t.settled_profit_cents>0?"text-green-600 dark:text-green-400":t.settled_profit_cents<0?"text-red-600 dark:text-red-400":"text-gray-900 dark:text-gray-100"}`,children:n(t.settled_profit_cents,!0)}),e.jsx("td",{className:`py-3 px-4 text-right font-medium ${t.portfolio_value_cents>0?"text-green-600 dark:text-green-400":t.portfolio_value_cents<0?"text-red-600 dark:text-red-400":"text-gray-900 dark:text-gray-100"}`,children:n(t.portfolio_value_cents,!0)})]},t.user_id))}),a.length>0&&(()=>{const t=a.reduce((x,g)=>x+g.trade_count,0),d=a.reduce((x,g)=>x+g.open_orders_count,0),s=a.reduce((x,g)=>x+g.shares_traded,0),r=a.reduce((x,g)=>x+g.closed_profit_cents,0),p=a.reduce((x,g)=>x+g.settled_profit_cents,0),h=a.reduce((x,g)=>x+g.portfolio_value_cents,0),b=h+c;return e.jsxs("tfoot",{children:[e.jsxs("tr",{className:"border-t-2 border-gray-300 dark:border-gray-500 bg-gray-100 dark:bg-gray-800 font-semibold",children:[e.jsx("td",{className:"py-3 px-4 text-gray-900 dark:text-gray-100",children:"All participants"}),e.jsx("td",{className:"py-3 px-4 text-right",children:t}),e.jsx("td",{className:"py-3 px-4 text-right",children:d}),e.jsx("td",{className:"py-3 px-4 text-right",children:s}),e.jsx("td",{className:`py-3 px-4 text-right ${r>0?"text-green-600 dark:text-green-400":r<0?"text-red-600 dark:text-red-400":"text-gray-700 dark:text-gray-300"}`,children:n(r,!0)}),e.jsx("td",{className:`py-3 px-4 text-right ${p>0?"text-green-600 dark:text-green-400":p<0?"text-red-600 dark:text-red-400":"text-gray-700 dark:text-gray-300"}`,children:n(p,!0)}),e.jsx("td",{className:`py-3 px-4 text-right ${h>0?"text-green-600 dark:text-green-400":h<0?"text-red-600 dark:text-red-400":"text-gray-700 dark:text-gray-300"}`,children:n(h,!0)})]}),c!==0&&e.jsxs("tr",{className:"border-t border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800/80 font-medium",children:[e.jsx("td",{className:"py-2 px-4 text-gray-600 dark:text-gray-400 text-xs",children:"Unattributed (no user_id or deleted user)"}),e.jsx("td",{colSpan:5,className:"py-2 px-4"}),e.jsx("td",{className:`py-2 px-4 text-right ${c>0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:n(c,!0)})]}),e.jsxs("tr",{className:"border-t border-gray-300 dark:border-gray-500 bg-gray-100 dark:bg-gray-800 font-semibold",children:[e.jsx("td",{className:"py-3 px-4 text-gray-900 dark:text-gray-100",children:"Total (users + unattributed)"}),e.jsx("td",{colSpan:5,className:"py-3 px-4"}),e.jsx("td",{className:`py-3 px-4 text-right ${b===0?"text-gray-700 dark:text-gray-300":b>0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:n(b,!0)})]}),e.jsxs("tr",{className:"border-t border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800/80 font-medium",children:[e.jsx("td",{className:"py-2 px-4 text-gray-600 dark:text-gray-400 text-xs",children:"System total (all positions; should be $0)"}),e.jsx("td",{colSpan:5,className:"py-2 px-4"}),e.jsx("td",{className:`py-2 px-4 text-right font-semibold ${i===0?"text-green-600 dark:text-green-400":"text-amber-600 dark:text-amber-400"}`,children:n(i,!0)})]})]})})()]})})]})})}export{Z as LeaderboardPage};
