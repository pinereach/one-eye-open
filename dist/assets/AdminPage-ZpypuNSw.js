import{u as re,a as se,r as s,b as o,j as a,N as te}from"./index-Ca-ZKz1e.js";import{C as k,b as v}from"./Card-BvNUc82J.js";import{u as ne,T as le}from"./Toast-BpCKEbdF.js";import{C as L}from"./ConfirmModal-aucGmSs8.js";const R=3e3;let C=0;function me(){const{user:i}=re(),$=se(),{toasts:q,showToast:n,removeToast:D}=ne(),x=s.useRef(!1),[c,z]=s.useState([]),[b,N]=s.useState([]),[H,w]=s.useState(!1),[G,h]=s.useState(!1),[W,g]=s.useState(!1),[l,p]=s.useState(null),[M,S]=s.useState(!1),[_,A]=s.useState(!1),[J,T]=s.useState({}),[O,U]=s.useState(!1),[u,K]=s.useState(""),[m,Q]=s.useState(""),[f,B]=s.useState(""),[F,V]=s.useState("bid"),[y,E]=s.useState(""),[j,I]=s.useState("");if(s.useEffect(()=>{if(!i?.admin||x.current)return;const e=Date.now();if(e-C<R)return;x.current=!0,C=e;let t=!1;return w(!0),Promise.all([o.adminGetUsers(),o.getMarkets()]).then(([r,d])=>{t||(z(r.users??[]),N(d.markets??[]))}).catch(()=>{t||(x.current=!1,n("Failed to load admin data","error"))}).finally(()=>{t||w(!1)}),()=>{t=!0,setTimeout(()=>{C=0},R+500)}},[i?.admin]),i&&!i.admin)return a.jsx(te,{to:"/markets",replace:!0});const X=b.find(e=>e.market_id===m)?.outcomes??[];async function Y(){S(!0);try{const{canceled:e}=await o.adminCancelAllOrders();n(`${e} order(s) canceled`,"success")}catch(e){n(e instanceof Error?e.message:"Failed to cancel orders","error")}finally{S(!1),h(!1)}}async function Z(){if(l!=null){A(!0);try{const{canceled:e}=await o.adminCancelAllOrders(l),t=c.find(r=>r.id===l);n(`${e} order(s) canceled for ${t?.username??l}`,"success")}catch(e){n(e instanceof Error?e.message:"Failed to cancel orders","error")}finally{A(!1),g(!1),p(null)}}}async function ee(e,t){T(r=>({...r,[e]:!0}));try{await o.adminUpdateMarketPause(e,t),N(r=>r.map(d=>d.market_id===e?{...d,trading_paused:t?1:0}:d)),n(t?"Market paused":"Market resumed","success")}catch(r){n(r instanceof Error?r.message:"Failed to update market","error")}finally{T(r=>({...r,[e]:!1}))}}async function ae(e){e.preventDefault();const t=u===""?null:Number(u),r=y.trim()?parseInt(y,10):NaN,d=j.trim()?parseInt(j,10):NaN;if(t==null||!m||!f||Number.isNaN(r)||r<100||r>9900||Number.isNaN(d)||d<1){n("Fill all fields: user, market, outcome, price (100–9900), contracts (≥1)","error");return}U(!0);try{await o.adminCreateManualTrade({user_id:t,market_id:m,outcome_id:f,side:F,price:r,contract_size:d}),n("Manual trade created","success"),E(""),I("")}catch(P){n(P instanceof Error?P.message:"Failed to create manual trade","error")}finally{U(!1)}}return a.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[a.jsx("div",{className:"flex items-center gap-2 sm:gap-4",children:a.jsxs("button",{onClick:()=>$("/markets"),className:"flex items-center gap-2 px-3 sm:px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-primary-600 dark:hover:text-primary-400 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-800 transition touch-manipulation",children:[a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),a.jsx("span",{className:"hidden sm:inline",children:"Back"})]})}),a.jsx("h1",{className:"text-xl sm:text-2xl font-bold",children:"Admin"}),a.jsx(k,{children:a.jsxs(v,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Cancel orders"}),a.jsxs("div",{className:"flex flex-wrap gap-3 items-center",children:[a.jsx("button",{type:"button",onClick:()=>h(!0),disabled:M,className:"px-3 py-2 text-sm font-medium bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50",children:M?"Canceling…":"Cancel all open orders (all users)"}),a.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-sm",children:"or for user:"}),a.jsxs("select",{value:l??"",onChange:e=>p(e.target.value?Number(e.target.value):null),className:"border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select user"}),c.map(e=>a.jsxs("option",{value:e.id,children:[e.username," (id: ",e.id,")"]},e.id))]}),a.jsx("button",{type:"button",onClick:()=>l!=null&&g(!0),disabled:l==null||_,className:"px-3 py-2 text-sm font-medium bg-amber-600 text-white rounded-md hover:bg-amber-700 disabled:opacity-50",children:_?"Canceling…":"Cancel all for this user"})]})]})}),a.jsx(k,{children:a.jsxs(v,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Pause / resume trading by market"}),H?a.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Loading markets…"}):a.jsx("ul",{className:"space-y-2",children:b.map(e=>{const t=(e.trading_paused??0)===1,r=J[e.market_id];return a.jsxs("li",{className:"flex items-center justify-between gap-2 py-2 border-b border-gray-200 dark:border-gray-700 last:border-0",children:[a.jsx("span",{className:"text-sm font-medium truncate",children:e.short_name}),a.jsx("button",{type:"button",onClick:()=>ee(e.market_id,!t),disabled:r,className:`px-3 py-1.5 text-sm font-medium rounded-md disabled:opacity-50 ${t?"bg-green-600 text-white hover:bg-green-700":"bg-gray-500 text-white hover:bg-gray-600"}`,children:r?"…":t?"Resume":"Pause"})]},e.market_id)})})]})}),a.jsx(k,{children:a.jsxs(v,{children:[a.jsx("h2",{className:"text-base sm:text-lg font-bold mb-3",children:"Add manual trade"}),a.jsxs("form",{onSubmit:ae,className:"space-y-3",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"User"}),a.jsxs("select",{value:u===""?"":u,onChange:e=>K(e.target.value?Number(e.target.value):""),required:!0,className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select user"}),c.map(e=>a.jsxs("option",{value:e.id,children:[e.username," (id: ",e.id,")"]},e.id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Market"}),a.jsxs("select",{value:m,onChange:e=>{Q(e.target.value),B("")},required:!0,className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select market"}),b.map(e=>a.jsx("option",{value:e.market_id,children:e.short_name},e.market_id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Outcome"}),a.jsxs("select",{value:f,onChange:e=>B(e.target.value),required:!0,className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"",children:"Select outcome"}),X.map(e=>a.jsx("option",{value:e.outcome_id,children:e.name},e.outcome_id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Side"}),a.jsxs("select",{value:F,onChange:e=>V(e.target.value),className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm",children:[a.jsx("option",{value:"bid",children:"Bid (buy)"}),a.jsx("option",{value:"ask",children:"Ask (sell)"})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Price (cents, 100–9900)"}),a.jsx("input",{type:"number",min:100,max:9900,value:y,onChange:e=>E(e.target.value),placeholder:"e.g. 5000",className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Contract size"}),a.jsx("input",{type:"number",min:1,value:j,onChange:e=>I(e.target.value),placeholder:"e.g. 10",className:"w-full border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1.5 bg-white dark:bg-gray-800 text-sm"})]}),a.jsx("button",{type:"submit",disabled:O,className:"px-3 py-2 text-sm font-medium bg-primary-600 text-white rounded-md hover:bg-primary-700 disabled:opacity-50",children:O?"Creating…":"Add manual trade"})]})]})}),a.jsx(L,{isOpen:G,onClose:()=>h(!1),onConfirm:Y,title:"Cancel all open orders",message:"Cancel all open/partial orders for every user? This cannot be undone.",confirmLabel:"Cancel all",variant:"danger"}),a.jsx(L,{isOpen:W,onClose:()=>{g(!1),p(null)},onConfirm:Z,title:"Cancel all orders for this user",message:l!=null?`Cancel all open/partial orders for user ${c.find(e=>e.id===l)?.username??l}?`:"",confirmLabel:"Cancel all",variant:"danger"}),a.jsx(le,{toasts:q,removeToast:D})]})}export{me as AdminPage};
