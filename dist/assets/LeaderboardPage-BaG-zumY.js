import{u as L,r as m,j as e,N as T,b as U}from"./index-BsuGSwNh.js";import{C as P,b as D}from"./Card-BiAtB9YM.js";import{P as E}from"./PullToRefresh-CsMYa0-q.js";function c(u,r=!1){const f=u/100,y=Math.abs(f).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});return r?u>=0?`+$${y}`:`-$${y}`:`$${y}`}const A="shares_traded",F="desc";function M(){const{user:u}=L(),[r,f]=m.useState([]),[o,y]=m.useState(0),[x,S]=m.useState(0),[$,j]=m.useState(!0),[k,_]=m.useState(null),[n,C]=m.useState(A),[l,N]=m.useState(F),b=m.useMemo(()=>{if(r.length===0)return[];const t=n,s=l==="asc"?1:-1;return[...r].sort((d,a)=>{let p=0;if(t==="username")p=(d.username??"").localeCompare(a.username??"");else{const i=t==="portfolio_value_cents"?d.portfolio_value_cents:t==="trade_count"?d.trade_count:t==="open_orders_count"?d.open_orders_count:d.shares_traded,g=t==="portfolio_value_cents"?a.portfolio_value_cents:t==="trade_count"?a.trade_count:t==="open_orders_count"?a.open_orders_count:a.shares_traded;p=i-g}return p*s})},[r,n,l]);function h(t){n===t?N(s=>s==="asc"?"desc":"asc"):(C(t),N(t==="username"?"asc":"desc"))}async function v(){j(!0),_(null);try{const{leaderboard:t,unattributed_portfolio_value_cents:s,system_total_portfolio_value_cents:d}=await U.adminGetLeaderboard();f(t??[]),y(s??0),S(d??0)}catch(t){console.error("Failed to load leaderboard:",t),_(t instanceof Error?t.message:"Failed to load leaderboard")}finally{j(!1)}}return m.useEffect(()=>{u?.admin&&v()},[u?.admin]),u&&!u.admin?e.jsx(T,{to:"/markets",replace:!0}):$&&r.length===0?e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-gray-900 dark:text-gray-100",children:"Leaderboard"}),e.jsx("div",{className:"animate-pulse space-y-2",children:[1,2,3,4,5].map(t=>e.jsx("div",{className:"h-14 bg-gray-200 dark:bg-gray-700 rounded-lg"},t))})]}):k?e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-gray-900 dark:text-gray-100",children:"Leaderboard"}),e.jsx("p",{className:"text-sm text-red-600 dark:text-red-400",children:k})]}):e.jsx(E,{onRefresh:v,children:e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-gray-900 dark:text-gray-100",children:"Leaderboard"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Per-user stats: trades, open orders, shares traded, portfolio value (P&L). Zero-sum: system total should be $0."}),r.length>0&&e.jsxs("div",{className:`rounded-lg border p-4 ${x===0?"border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800/80":"border-amber-400 dark:border-amber-500 bg-amber-50 dark:bg-amber-900/20"}`,children:[e.jsx("div",{className:"text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1",children:"Debug checks"}),e.jsxs("div",{className:"flex flex-wrap gap-x-6 gap-y-1 text-sm",children:[e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"System total (sum of all position P&L):"})," ",e.jsx("span",{className:`font-semibold ${x===0?"text-green-600 dark:text-green-400":"text-amber-600 dark:text-amber-400"}`,children:c(x,!0)}),x!==0&&e.jsx("span",{className:"ml-2 text-amber-600 dark:text-amber-400 text-xs",children:"(should be $0 — check trade/position logic)"})]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Users + Unattributed:"})," ",e.jsx("span",{className:`font-semibold ${r.reduce((t,s)=>t+s.portfolio_value_cents,0)+o===x?"text-green-600 dark:text-green-400":"text-amber-600 dark:text-amber-400"}`,children:c(r.reduce((t,s)=>t+s.portfolio_value_cents,0)+o,!0)}),r.reduce((t,s)=>t+s.portfolio_value_cents,0)+o!==x&&e.jsx("span",{className:"ml-2 text-amber-600 dark:text-amber-400 text-xs",children:"(should equal system total)"})]})]})]}),e.jsx("div",{className:"md:hidden space-y-3",children:b.length===0?e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 py-4",children:"No users."}):b.map(t=>e.jsx(P,{children:e.jsxs(D,{className:"p-4",children:[e.jsx("div",{className:"font-semibold text-gray-900 dark:text-gray-100 mb-3",children:t.username}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Trades"}),e.jsx("span",{className:"text-right font-medium",children:t.trade_count}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Open orders"}),e.jsx("span",{className:"text-right font-medium",children:t.open_orders_count}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Shares traded"}),e.jsx("span",{className:"text-right font-medium",children:t.shares_traded}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Portfolio value"}),e.jsx("span",{className:`text-right font-medium ${t.portfolio_value_cents>0?"text-green-600 dark:text-green-400":t.portfolio_value_cents<0?"text-red-600 dark:text-red-400":""}`,children:c(t.portfolio_value_cents,!0)})]})]})},t.user_id))}),r.length>0&&(()=>{const t=r.reduce((d,a)=>d+a.portfolio_value_cents,0),s=t+o;return e.jsxs("div",{className:"md:hidden rounded-lg border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800/80 p-4",children:[e.jsx("div",{className:"text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-2",children:"Summary (all participants)"}),e.jsxs("div",{className:"flex flex-wrap gap-x-6 gap-y-1 text-sm",children:[e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Trades:"})," ",e.jsx("span",{className:"font-semibold",children:r.reduce((d,a)=>d+a.trade_count,0)})]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Open orders:"})," ",e.jsx("span",{className:"font-semibold",children:r.reduce((d,a)=>d+a.open_orders_count,0)})]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Shares traded:"})," ",e.jsx("span",{className:"font-semibold",children:r.reduce((d,a)=>d+a.shares_traded,0)})]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Portfolio (users):"})," ",e.jsx("span",{className:`font-semibold ${t>0?"text-green-600 dark:text-green-400":t<0?"text-red-600 dark:text-red-400":"text-gray-700 dark:text-gray-300"}`,children:c(t,!0)})]}),o!==0&&e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Unattributed:"})," ",e.jsx("span",{className:`font-semibold ${o>0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:c(o,!0)})]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Total (users + unattributed):"})," ",e.jsx("span",{className:`font-semibold ${s===0?"text-gray-700 dark:text-gray-300":s>0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:c(s,!0)})]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"System total:"})," ",e.jsx("span",{className:`font-semibold ${x===0?"text-green-600 dark:text-green-400":"text-amber-600 dark:text-amber-400"}`,children:c(x,!0)})]})]})]})})(),e.jsx("div",{className:"hidden md:block overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-600",children:e.jsxs("table",{className:"w-full min-w-[600px] border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800",children:[e.jsx("th",{className:"py-3 px-4 text-left text-xs font-bold text-gray-600 dark:text-gray-400",children:e.jsxs("button",{type:"button",onClick:()=>h("username"),className:"flex items-center gap-1 hover:text-primary-600 dark:hover:text-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded","aria-sort":n==="username"?l==="asc"?"ascending":"descending":void 0,children:["User ",n==="username"&&(l==="asc"?"↑":"↓")]})}),e.jsx("th",{className:"py-3 px-4 text-right text-xs font-bold text-gray-600 dark:text-gray-400",children:e.jsxs("button",{type:"button",onClick:()=>h("trade_count"),className:"inline-flex items-center gap-1 ml-auto hover:text-primary-600 dark:hover:text-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded","aria-sort":n==="trade_count"?l==="asc"?"ascending":"descending":void 0,children:["Trades ",n==="trade_count"&&(l==="asc"?"↑":"↓")]})}),e.jsx("th",{className:"py-3 px-4 text-right text-xs font-bold text-gray-600 dark:text-gray-400",children:e.jsxs("button",{type:"button",onClick:()=>h("open_orders_count"),className:"inline-flex items-center gap-1 ml-auto hover:text-primary-600 dark:hover:text-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded","aria-sort":n==="open_orders_count"?l==="asc"?"ascending":"descending":void 0,children:["Open orders ",n==="open_orders_count"&&(l==="asc"?"↑":"↓")]})}),e.jsx("th",{className:"py-3 px-4 text-right text-xs font-bold text-gray-600 dark:text-gray-400",children:e.jsxs("button",{type:"button",onClick:()=>h("shares_traded"),className:"inline-flex items-center gap-1 ml-auto hover:text-primary-600 dark:hover:text-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded","aria-sort":n==="shares_traded"?l==="asc"?"ascending":"descending":void 0,children:["Shares traded ",n==="shares_traded"&&(l==="asc"?"↑":"↓")]})}),e.jsx("th",{className:"py-3 px-4 text-right text-xs font-bold text-gray-600 dark:text-gray-400",children:e.jsxs("button",{type:"button",onClick:()=>h("portfolio_value_cents"),className:"inline-flex items-center gap-1 ml-auto hover:text-primary-600 dark:hover:text-primary-400 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded","aria-sort":n==="portfolio_value_cents"?l==="asc"?"ascending":"descending":void 0,children:["Portfolio value ",n==="portfolio_value_cents"&&(l==="asc"?"↑":"↓")]})})]})}),e.jsx("tbody",{children:b.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"py-8 text-center text-gray-500 dark:text-gray-400",children:"No users."})}):b.map(t=>e.jsxs("tr",{className:"border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800/50",children:[e.jsx("td",{className:"py-3 px-4 font-medium text-gray-900 dark:text-gray-100",children:t.username}),e.jsx("td",{className:"py-3 px-4 text-right text-gray-700 dark:text-gray-300",children:t.trade_count}),e.jsx("td",{className:"py-3 px-4 text-right text-gray-700 dark:text-gray-300",children:t.open_orders_count}),e.jsx("td",{className:"py-3 px-4 text-right text-gray-700 dark:text-gray-300",children:t.shares_traded}),e.jsx("td",{className:`py-3 px-4 text-right font-medium ${t.portfolio_value_cents>0?"text-green-600 dark:text-green-400":t.portfolio_value_cents<0?"text-red-600 dark:text-red-400":"text-gray-900 dark:text-gray-100"}`,children:c(t.portfolio_value_cents,!0)})]},t.user_id))}),r.length>0&&(()=>{const t=r.reduce((i,g)=>i+g.trade_count,0),s=r.reduce((i,g)=>i+g.open_orders_count,0),d=r.reduce((i,g)=>i+g.shares_traded,0),a=r.reduce((i,g)=>i+g.portfolio_value_cents,0),p=a+o;return e.jsxs("tfoot",{children:[e.jsxs("tr",{className:"border-t-2 border-gray-300 dark:border-gray-500 bg-gray-100 dark:bg-gray-800 font-semibold",children:[e.jsx("td",{className:"py-3 px-4 text-gray-900 dark:text-gray-100",children:"All participants"}),e.jsx("td",{className:"py-3 px-4 text-right",children:t}),e.jsx("td",{className:"py-3 px-4 text-right",children:s}),e.jsx("td",{className:"py-3 px-4 text-right",children:d}),e.jsx("td",{className:`py-3 px-4 text-right ${a>0?"text-green-600 dark:text-green-400":a<0?"text-red-600 dark:text-red-400":"text-gray-700 dark:text-gray-300"}`,children:c(a,!0)})]}),o!==0&&e.jsxs("tr",{className:"border-t border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800/80 font-medium",children:[e.jsx("td",{className:"py-2 px-4 text-gray-600 dark:text-gray-400 text-xs",children:"Unattributed (no user_id or deleted user)"}),e.jsx("td",{colSpan:3,className:"py-2 px-4"}),e.jsx("td",{className:`py-2 px-4 text-right ${o>0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:c(o,!0)})]}),e.jsxs("tr",{className:"border-t border-gray-300 dark:border-gray-500 bg-gray-100 dark:bg-gray-800 font-semibold",children:[e.jsx("td",{className:"py-3 px-4 text-gray-900 dark:text-gray-100",children:"Total (users + unattributed)"}),e.jsx("td",{colSpan:3,className:"py-3 px-4"}),e.jsx("td",{className:`py-3 px-4 text-right ${p===0?"text-gray-700 dark:text-gray-300":p>0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:c(p,!0)})]}),e.jsxs("tr",{className:"border-t border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800/80 font-medium",children:[e.jsx("td",{className:"py-2 px-4 text-gray-600 dark:text-gray-400 text-xs",children:"System total (all positions; should be $0)"}),e.jsx("td",{colSpan:3,className:"py-2 px-4"}),e.jsx("td",{className:`py-2 px-4 text-right font-semibold ${x===0?"text-green-600 dark:text-green-400":"text-amber-600 dark:text-amber-400"}`,children:c(x,!0)})]})]})})()]})})]})})}export{M as LeaderboardPage};
